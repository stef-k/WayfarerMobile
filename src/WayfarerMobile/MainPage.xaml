<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:mapsui="clr-namespace:Mapsui.UI.Maui;assembly=Mapsui.UI.Maui"
             xmlns:controls="clr-namespace:WayfarerMobile.Views.Controls"
             xmlns:shared="clr-namespace:WayfarerMobile.Shared.Controls"
             xmlns:bottomSheet="clr-namespace:Syncfusion.Maui.Toolkit.BottomSheet;assembly=Syncfusion.Maui.Toolkit"
             x:Class="WayfarerMobile.MainPage"
             x:DataType="vm:MainViewModel"
             Title="{Binding PageTitle}">

    <Grid>
        <!-- Main SfBottomSheet - wraps the map and shows either Check-In or Trip content -->
        <bottomSheet:SfBottomSheet x:Name="MainBottomSheet"
                                   IsOpen="{Binding IsAnySheetOpen, Mode=TwoWay}"
                                   State="FullExpanded"
                                   AllowedState="All"
                                   HalfExpandedRatio="0.6"
                                   FullExpandedRatio="0.98"
                                   EnableSwiping="True"
                                   IsModal="True"
                                   ShowGrabber="True"
                                   GrabberWidth="40"
                                   GrabberHeight="4"
                                   CornerRadius="16"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

            <!-- Main Content: Map and overlays -->
            <bottomSheet:SfBottomSheet.Content>
                <Grid>
                    <!-- Offline Banner (auto-shows when no network) -->
                    <controls:OfflineBanner VerticalOptions="Start" ZIndex="10" />

                    <!-- Map takes full screen -->
                    <mapsui:MapControl x:Name="MapControl"
                                       Map="{Binding Map}"
                                       HorizontalOptions="Fill"
                                       VerticalOptions="Fill"
                                       ZIndex="0" />

                    <!-- Floating status overlay at top (2 rows, tappable to copy coords) -->
                    <Frame VerticalOptions="Start"
                           HorizontalOptions="Start"
                           Margin="8,8,0,0"
                           Padding="12,6"
                           CornerRadius="16"
                           BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                           Opacity="0.95"
                           ZIndex="5">
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding CopyCoordinatesCommand}" />
                        </Frame.GestureRecognizers>
                        <VerticalStackLayout Spacing="2">
                            <!-- Row 1: Status + Coordinates -->
                            <HorizontalStackLayout Spacing="8">
                                <Label Text="{Binding StatusText}"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       VerticalOptions="Center" />
                                <Label Text="{Binding LocationText}"
                                       FontSize="12"
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                            </HorizontalStackLayout>
                            <!-- Row 2: Accuracy, Heading, Altitude, Cache Health -->
                            <HorizontalStackLayout Spacing="8" VerticalOptions="Center">
                                <Label Text="{Binding AccuracyText}"
                                       FontSize="11"
                                       IsVisible="{Binding HasAccuracy}"
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                                <Label Text="{Binding HeadingText}"
                                       FontSize="11"
                                       IsVisible="{Binding HasHeading}"
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                                <Label Text="{Binding AltitudeText, StringFormat='Alt: {0}'}"
                                       FontSize="11"
                                       IsVisible="{Binding HasAltitude}"
                                       VerticalOptions="Center"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />
                                <!-- Cache health indicator (tappable, larger hit area) -->
                                <Border Padding="4,0" StrokeThickness="0" BackgroundColor="Transparent" VerticalOptions="Center">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ShowCacheStatusCommand}" />
                                    </Border.GestureRecognizers>
                                    <HorizontalStackLayout Spacing="4" VerticalOptions="Center">
                                        <Ellipse WidthRequest="10"
                                                 HeightRequest="10"
                                                 Fill="{Binding CacheHealthColor}"
                                                 VerticalOptions="Center" />
                                        <Label Text="{Binding CacheHealthTooltip}"
                                               FontSize="11"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                                               VerticalOptions="Center" />
                                    </HorizontalStackLayout>
                                </Border>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Top Right: Reset North -->
                    <ImageButton Source="explore_compass.png"
                                 Command="{Binding ResetNorthCommand}"
                                 VerticalOptions="Start"
                                 HorizontalOptions="End"
                                 Margin="0,8,15,0"
                                 WidthRequest="44"
                                 HeightRequest="44"
                                 CornerRadius="22"
                                 Padding="10"
                                 BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                                 ZIndex="5" />

                    <!-- Bottom Right: Action FABs (vertical, top to bottom) -->
                    <VerticalStackLayout VerticalOptions="End"
                                         HorizontalOptions="End"
                                         Margin="0,0,15,30"
                                         Spacing="12"
                                         ZIndex="5">
                        <!-- 0. Trip Overview (visible when trip loaded) -->
                        <ImageButton Source="trip.png"
                                     Command="{Binding ToggleTripSheetCommand}"
                                     IsVisible="{Binding HasLoadedTrip}"
                                     WidthRequest="44"
                                     HeightRequest="44"
                                     CornerRadius="22"
                                     Padding="10"
                                     BackgroundColor="{StaticResource Gray900}" />
                        <!-- 1. Drop Pin / Context Menu -->
                        <ImageButton Source="add_location_alt.png"
                                     Clicked="OnDropPinClicked"
                                     WidthRequest="44"
                                     HeightRequest="44"
                                     CornerRadius="22"
                                     Padding="10"
                                     BackgroundColor="{StaticResource Gray900}" />
                        <!-- 2. Recenter on user's location (MIDDLE) -->
                        <ImageButton Source="crosshair.png"
                                     Command="{Binding CenterOnLocationCommand}"
                                     WidthRequest="44"
                                     HeightRequest="44"
                                     CornerRadius="22"
                                     Padding="10"
                                     BackgroundColor="{StaticResource Gray900}" />
                        <!-- 3. Check-in -->
                        <ImageButton Source="check.png"
                                     Command="{Binding CheckInCommand}"
                                     WidthRequest="44"
                                     HeightRequest="44"
                                     CornerRadius="22"
                                     Padding="10"
                                     BackgroundColor="{StaticResource Gray900}" />
                    </VerticalStackLayout>

                    <!-- Navigation HUD (shown during navigation) -->
                    <controls:NavigationHud BindingContext="{Binding NavigationHud}"
                                            VerticalOptions="End"
                                            HorizontalOptions="Fill"
                                            Margin="10,0,10,10"
                                            ZIndex="15" />

                    <!-- Place Coordinate Edit Overlay (shown when editing place coordinates) -->
                    <Border VerticalOptions="Start"
                            HorizontalOptions="Fill"
                            Margin="8,60,8,0"
                            Padding="16,12"
                            BackgroundColor="{AppThemeBinding Light=Black, Dark={StaticResource Gray900}}"
                            Opacity="0.95"
                            StrokeThickness="0"
                            IsVisible="{Binding IsPlaceCoordinateEditMode}"
                            ZIndex="20">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12" />
                        </Border.StrokeShape>
                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto,Auto" RowSpacing="4" ColumnSpacing="12">
                            <!-- Row 0: Place name and coordinates -->
                            <VerticalStackLayout Grid.Row="0" Grid.Column="0">
                                <Label Text="{Binding PlaceBeingEditedForCoordinates.Name, StringFormat='Editing: {0}'}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       LineBreakMode="TailTruncation" />
                                <Label Text="{Binding PendingPlaceCoordinatesText}"
                                       FontSize="12"
                                       TextColor="{StaticResource Gray300}" />
                            </VerticalStackLayout>
                            <!-- Cancel Button -->
                            <Button Grid.Row="0" Grid.Column="1"
                                    Text="Cancel"
                                    Command="{Binding CancelPlaceCoordinateEditingCommand}"
                                    BackgroundColor="Transparent"
                                    BorderColor="{StaticResource Gray400}"
                                    BorderWidth="1"
                                    TextColor="White"
                                    FontSize="13"
                                    HeightRequest="36"
                                    Padding="12,0"
                                    CornerRadius="18" />
                            <!-- Save Button -->
                            <Button Grid.Row="0" Grid.Column="2"
                                    Text="Save"
                                    Command="{Binding SavePlaceCoordinatesCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    FontSize="13"
                                    HeightRequest="36"
                                    Padding="16,0"
                                    CornerRadius="18" />
                            <!-- Hint text -->
                            <Label Grid.Row="1" Grid.ColumnSpan="3"
                                   Text="Tap anywhere on the map to set the new location"
                                   FontSize="11"
                                   TextColor="{StaticResource Gray400}"
                                   HorizontalTextAlignment="Center" />
                        </Grid>
                    </Border>
                </Grid>
            </bottomSheet:SfBottomSheet.Content>

            <!-- Bottom Sheet Content: Either Check-In or Trip Overview -->
            <bottomSheet:SfBottomSheet.BottomSheetContent>
                <Grid BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                    <!-- Check-In Content (visible when check-in sheet is open) -->
                    <Grid RowDefinitions="Auto,*,Auto"
                          IsVisible="{Binding IsCheckInSheetOpen}"
                          BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

                        <!-- Header Section -->
                    <Grid Grid.Row="0" Padding="16,8,16,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Title -->
                        <Label Text="Check In"
                               Style="{StaticResource SubHeadline}"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />

                        <!-- Close Button -->
                        <Button Grid.Column="1"
                                Text="✕"
                                FontSize="16"
                                WidthRequest="36"
                                HeightRequest="36"
                                Padding="0"
                                CornerRadius="18"
                                BackgroundColor="Transparent"
                                TextColor="{StaticResource TextSecondary}"
                                Clicked="OnCheckInCloseClicked" />
                    </Grid>

                    <!-- Form Content -->
                    <ScrollView Grid.Row="1"
                                Padding="0,0,0,50">
                        <VerticalStackLayout Spacing="16" Padding="16,0,16,100">

                            <!-- Location Status with Share Options -->
                            <Border Padding="12"
                                    StrokeThickness="1"
                                    Stroke="{StaticResource Gray200}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                                    <Image Grid.Column="0"
                                           Source="add_location.png"
                                           WidthRequest="24"
                                           HeightRequest="24"
                                           VerticalOptions="Center" />
                                    <VerticalStackLayout Grid.Column="1"
                                                         VerticalOptions="Center"
                                                         Spacing="2"
                                                         Margin="12,0,0,0">
                                        <Label Text="{Binding CheckInViewModel.LocationText}"
                                               FontSize="13"
                                               FontAttributes="Bold"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                        <Label Text="Current Location"
                                               FontSize="11"
                                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource Gray400}}" />
                                    </VerticalStackLayout>
                                    <!-- Share to Google Maps -->
                                    <ImageButton Grid.Column="2"
                                                 Source="share_icon.png"
                                                 Clicked="OnCheckInShareLocationClicked"
                                                 WidthRequest="32"
                                                 HeightRequest="32"
                                                 Padding="6"
                                                 BackgroundColor="Transparent"
                                                 ToolTipProperties.Text="Share Location"
                                                 IsEnabled="{Binding CheckInViewModel.HasLocation}" />
                                    <!-- Copy Coordinates -->
                                    <ImageButton Grid.Column="3"
                                                 Source="info.png"
                                                 Clicked="OnCheckInCopyCoordinatesClicked"
                                                 WidthRequest="32"
                                                 HeightRequest="32"
                                                 Padding="6"
                                                 BackgroundColor="Transparent"
                                                 ToolTipProperties.Text="Copy Coordinates"
                                                 IsEnabled="{Binding CheckInViewModel.HasLocation}" />
                                    <ActivityIndicator Grid.Column="4"
                                                       IsRunning="{Binding CheckInViewModel.IsBusy}"
                                                       IsVisible="{Binding CheckInViewModel.IsBusy}"
                                                       WidthRequest="20"
                                                       HeightRequest="20"
                                                       Color="{StaticResource Primary}" />
                                </Grid>
                            </Border>

                            <!-- Activity Type -->
                            <VerticalStackLayout Spacing="4">
                                <Label Text="Activity Type"
                                       Style="{StaticResource Caption}"
                                       FontAttributes="Bold" />
                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                    <shared:ComboBox Grid.Column="0"
                                                     Placeholder="Select an Activity"
                                                     ItemsSource="{Binding CheckInViewModel.ActivityTypes}"
                                                     SelectedItem="{Binding CheckInViewModel.SelectedActivity, Mode=TwoWay}"
                                                     DisplayMemberPath="Name"
                                                     VisibleItemCount="5" />
                                    <Button Grid.Column="1"
                                            Text="↻"
                                            FontSize="14"
                                            WidthRequest="36"
                                            HeightRequest="36"
                                            CornerRadius="18"
                                            Padding="0"
                                            Command="{Binding CheckInViewModel.RefreshActivitiesCommand}"
                                            IsEnabled="{Binding CheckInViewModel.IsLoadingActivities, Converter={StaticResource InvertedBoolConverter}}"
                                            BackgroundColor="{StaticResource Gray200}"
                                            TextColor="{StaticResource Gray600}"
                                            VerticalOptions="Center" />
                                </Grid>
                            </VerticalStackLayout>

                            <!-- Notes -->
                            <VerticalStackLayout x:Name="NotesSection" Spacing="4">
                                <Label Text="Notes (optional)"
                                       Style="{StaticResource Caption}"
                                       FontAttributes="Bold" />
                                <Border Padding="8"
                                        StrokeThickness="1"
                                        Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="8" />
                                    </Border.StrokeShape>
                                    <Editor x:Name="NotesEditor"
                                            Text="{Binding CheckInViewModel.Notes}"
                                            Placeholder="Add notes about this location..."
                                            PlaceholderColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                            TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"
                                            BackgroundColor="Transparent"
                                            HeightRequest="80"
                                            AutoSize="TextChanges"
                                            Focused="OnNotesEditorFocused" />
                                </Border>
                            </VerticalStackLayout>

                        </VerticalStackLayout>
                    </ScrollView>

                    <!-- Check In Button -->
                    <Grid Grid.Row="2"
                          Padding="16"
                          BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                        <Button Text="Check In"
                                Command="{Binding CheckInViewModel.SubmitCheckInCommand}"
                                IsEnabled="{Binding CheckInViewModel.HasLocation}"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"
                                CornerRadius="8"
                                HeightRequest="48" />
                    </Grid>

                    <!-- Loading/Success Overlay -->
                    <Border Grid.RowSpan="3"
                            IsVisible="{Binding CheckInViewModel.ShowOverlay}"
                            BackgroundColor="#80000000">
                        <VerticalStackLayout VerticalOptions="Center"
                                             HorizontalOptions="Center"
                                             Spacing="16">
                            <!-- Show spinner when submitting, checkmark when success -->
                            <ActivityIndicator IsRunning="True"
                                               IsVisible="{Binding CheckInViewModel.IsSubmitting}"
                                               Color="{StaticResource Primary}"
                                               WidthRequest="48"
                                               HeightRequest="48" />
                            <Label Text="✓"
                                   IsVisible="{Binding CheckInViewModel.IsSuccess}"
                                   TextColor="{StaticResource Success}"
                                   FontSize="48"
                                   HorizontalOptions="Center" />
                            <Label Text="{Binding CheckInViewModel.OverlayMessage}"
                                   TextColor="White"
                                   FontSize="16" />
                        </VerticalStackLayout>
                    </Border>
                    </Grid>

                    <!-- Trip Overview Content (visible when trip sheet is open) -->
                    <controls:TripOverviewContent x:Name="TripOverviewContent"
                                                  IsVisible="{Binding IsTripSheetOpen}" />
                </Grid>
            </bottomSheet:SfBottomSheet.BottomSheetContent>
        </bottomSheet:SfBottomSheet>

        <!-- Place Context Menu (outside bottom sheet so it overlays everything) -->
        <controls:PlaceContextMenu x:Name="ContextMenu"
                                   IsVisible="{Binding IsContextMenuVisible}"
                                   Latitude="{Binding ContextMenuLatitude}"
                                   Longitude="{Binding ContextMenuLongitude}"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center"
                                   ZIndex="20" />

        <!-- Navigation Method Picker (overlay, doesn't affect layout) -->
        <controls:NavigationMethodPicker x:Name="NavigationMethodPicker"
                                         IsVisible="False"
                                         InputTransparent="True" />
    </Grid>

</ContentPage>
