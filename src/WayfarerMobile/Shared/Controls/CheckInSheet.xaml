<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:WayfarerMobile.Shared.Controls"
             xmlns:vm="clr-namespace:WayfarerMobile.ViewModels"
             x:Class="WayfarerMobile.Shared.Controls.CheckInSheet"
             x:Name="Root"
             x:DataType="vm:CheckInViewModel"
             IsVisible="{Binding IsOpen, Source={x:Reference Root}}"
             HorizontalOptions="Fill"
             VerticalOptions="End">

    <!-- Simple sliding panel instead of SfBottomSheet -->
    <Border x:Name="SheetContainer"
            BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
            StrokeThickness="0"
            Padding="0">
        <Border.StrokeShape>
            <RoundRectangle CornerRadius="16,16,0,0" />
        </Border.StrokeShape>

        <!-- Sheet Content -->
            <Grid RowDefinitions="Auto,*,Auto"
                  BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

                <!-- Header Section -->
                <Grid Grid.Row="0" Padding="16,8,16,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Title -->
                    <Label Text="Check In"
                           Style="{StaticResource SubHeadline}"
                           FontAttributes="Bold"
                           VerticalOptions="Center" />

                    <!-- Close Button -->
                    <Button Grid.Column="1"
                            Text="âœ•"
                            FontSize="16"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            CornerRadius="18"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource TextSecondary}"
                            Clicked="OnCloseClicked" />
                </Grid>

                <!-- Form Content -->
                <ScrollView Grid.Row="1">
                    <VerticalStackLayout Spacing="16" Padding="16,0,16,16">

                        <!-- Location Status -->
                        <Border Padding="12"
                                StrokeThickness="1"
                                Stroke="{StaticResource Gray200}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <HorizontalStackLayout Spacing="12">
                                <Label Text="ðŸ“"
                                       FontSize="20"
                                       VerticalOptions="Center" />
                                <VerticalStackLayout VerticalOptions="Center" Spacing="2">
                                    <Label Text="{Binding LocationText}"
                                           FontSize="13"
                                           FontAttributes="Bold" />
                                    <Label Text="Current Location"
                                           FontSize="11"
                                           TextColor="{StaticResource TextSecondary}" />
                                </VerticalStackLayout>
                                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                                   IsVisible="{Binding IsBusy}"
                                                   WidthRequest="20"
                                                   HeightRequest="20"
                                                   Color="{StaticResource Primary}"
                                                   HorizontalOptions="EndAndExpand" />
                                <Button Text="â†»"
                                        FontSize="14"
                                        WidthRequest="36"
                                        HeightRequest="36"
                                        CornerRadius="18"
                                        Padding="0"
                                        Command="{Binding RefreshLocationCommand}"
                                        IsVisible="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                                        BackgroundColor="{StaticResource Gray200}"
                                        TextColor="{StaticResource Gray600}"
                                        HorizontalOptions="End" />
                            </HorizontalStackLayout>
                        </Border>

                        <!-- Activity Type -->
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Activity Type"
                                   Style="{StaticResource Caption}"
                                   FontAttributes="Bold" />
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                <controls:ComboBox Grid.Column="0"
                                                   Placeholder="Select an Activity"
                                                   ItemsSource="{Binding ActivityTypes}"
                                                   SelectedItem="{Binding SelectedActivity, Mode=TwoWay}"
                                                   DisplayMemberPath="Name"
                                                   VisibleItemCount="5" />
                                <Button Grid.Column="1"
                                        Text="â†»"
                                        FontSize="14"
                                        WidthRequest="36"
                                        HeightRequest="36"
                                        CornerRadius="18"
                                        Padding="0"
                                        Command="{Binding RefreshActivitiesCommand}"
                                        IsEnabled="{Binding IsLoadingActivities, Converter={StaticResource InvertedBoolConverter}}"
                                        BackgroundColor="{StaticResource Gray200}"
                                        TextColor="{StaticResource Gray600}"
                                        VerticalOptions="Center" />
                            </Grid>
                        </VerticalStackLayout>

                        <!-- Notes -->
                        <VerticalStackLayout Spacing="4">
                            <Label Text="Notes (optional)"
                                   Style="{StaticResource Caption}"
                                   FontAttributes="Bold" />
                            <Border Padding="8"
                                    StrokeThickness="1"
                                    Stroke="{StaticResource Gray200}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="8" />
                                </Border.StrokeShape>
                                <Editor Text="{Binding Notes}"
                                        Placeholder="Add notes about this location..."
                                        HeightRequest="80"
                                        AutoSize="TextChanges" />
                            </Border>
                        </VerticalStackLayout>

                        <!-- Result Message -->
                        <Border Padding="12"
                                IsVisible="{Binding IsSuccess}"
                                BackgroundColor="{Binding IsSuccess, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#E8F5E9|#FFEBEE'}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <Label Text="{Binding OverlayMessage}"
                                   TextColor="{Binding IsSuccess, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#2E7D32|#C62828'}"
                                   HorizontalTextAlignment="Center" />
                        </Border>

                    </VerticalStackLayout>
                </ScrollView>

                <!-- Action Buttons -->
                <Grid Grid.Row="2"
                      ColumnDefinitions="*,*"
                      ColumnSpacing="12"
                      Padding="16"
                      BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

                    <Button Grid.Column="0"
                            Text="Cancel"
                            Clicked="OnCloseClicked"
                            BackgroundColor="{StaticResource Gray200}"
                            TextColor="{StaticResource Gray600}"
                            CornerRadius="8"
                            HeightRequest="48" />

                    <Button Grid.Column="1"
                            Text="{Binding IsSubmitting, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Submitting...|Check In'}"
                            Command="{Binding SubmitCheckInCommand}"
                            CommandParameter="{x:Reference Root}"
                            IsEnabled="{Binding HasLocation}"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"
                            CornerRadius="8"
                            HeightRequest="48" />
                </Grid>

                <!-- Loading Overlay -->
                <Border Grid.RowSpan="3"
                        IsVisible="{Binding IsSubmitting}"
                        BackgroundColor="#80000000">
                    <VerticalStackLayout VerticalOptions="Center"
                                        HorizontalOptions="Center"
                                        Spacing="16">
                        <ActivityIndicator IsRunning="True"
                                           Color="{StaticResource Primary}"
                                           WidthRequest="48"
                                           HeightRequest="48" />
                        <Label Text="Submitting check-in..."
                               TextColor="White"
                               FontSize="16" />
                    </VerticalStackLayout>
                </Border>
            </Grid>
    </Border>
</ContentView>
