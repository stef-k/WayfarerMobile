<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="WayfarerMobile.Shared.Controls.ComboBox"
             x:Name="thisControl">

    <Grid RowDefinitions="Auto,Auto">

        <!-- Collapsed View: Selected Value + Dropdown Arrow -->
        <Border x:Name="collapsedBorder"
                StrokeThickness="1.5"
                Stroke="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                Padding="12,10"
                HeightRequest="48">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="8" />
            </Border.StrokeShape>
            <Border.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnCollapsedTapped" />
            </Border.GestureRecognizers>

            <Grid ColumnDefinitions="*,Auto,Auto">
                <!-- Selected Value or Placeholder -->
                <Label x:Name="selectedLabel"
                       Grid.Column="0"
                       Text="{Binding DisplayText, Source={x:Reference thisControl}}"
                       TextColor="{Binding DisplayTextColor, Source={x:Reference thisControl}}"
                       FontSize="14"
                       VerticalOptions="Center"
                       LineBreakMode="TailTruncation" />

                <!-- Clear Button (only visible when item selected) -->
                <Label x:Name="clearButton"
                       Grid.Column="1"
                       Text="âœ•"
                       FontSize="14"
                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                       VerticalOptions="Center"
                       Margin="8,0"
                       IsVisible="{Binding HasSelection, Source={x:Reference thisControl}}">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnClearTapped" />
                    </Label.GestureRecognizers>
                </Label>

                <!-- Dropdown Arrow -->
                <Label x:Name="dropdownArrow"
                       Grid.Column="2"
                       Text="â–¼"
                       FontSize="10"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                       VerticalOptions="Center" />
            </Grid>
        </Border>

        <!-- Expanded View: Search + List -->
        <Border x:Name="expandedBorder"
                Grid.Row="1"
                IsVisible="False"
                StrokeThickness="1"
                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                Margin="0,-1,0,0"
                ZIndex="100">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="0,0,8,8" />
            </Border.StrokeShape>
            <Border.Shadow>
                <Shadow Brush="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Black}}"
                        Offset="0,4"
                        Radius="8"
                        Opacity="0.3" />
            </Border.Shadow>

            <Grid RowDefinitions="Auto,*">
                <!-- Search Input -->
                <Border Grid.Row="0"
                        StrokeThickness="0,0,0,1"
                        Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                        Padding="8,6"
                        BackgroundColor="Transparent">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <!-- Search Icon -->
                        <Label Grid.Column="0"
                               Text="ðŸ”"
                               FontSize="14"
                               VerticalOptions="Center"
                               Margin="0,0,8,0"
                               Opacity="0.6" />

                        <!-- Search Entry -->
                        <Entry x:Name="searchEntry"
                               Grid.Column="1"
                               Placeholder="Search..."
                               PlaceholderColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                               TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}"
                               BackgroundColor="Transparent"
                               FontSize="14"
                               TextChanged="OnSearchTextChanged" />

                        <!-- Clear Search Button -->
                        <Label x:Name="clearSearchButton"
                               Grid.Column="2"
                               Text="âœ•"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                               VerticalOptions="Center"
                               IsVisible="False">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnClearSearchTapped" />
                            </Label.GestureRecognizers>
                        </Label>
                    </Grid>
                </Border>

                <!-- Items List (ItemTemplate set in code-behind for DisplayMemberPath support) -->
                <CollectionView x:Name="itemsList"
                                Grid.Row="1"
                                ItemsSource="{Binding FilteredItems, Source={x:Reference thisControl}}"
                                SelectionMode="None"
                                MaximumHeightRequest="{Binding ListMaxHeight, Source={x:Reference thisControl}}">
                    <CollectionView.EmptyView>
                        <Grid Padding="12,16">
                            <Label Text="No matches found"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                   HorizontalOptions="Center" />
                        </Grid>
                    </CollectionView.EmptyView>
                </CollectionView>
            </Grid>
        </Border>
    </Grid>
</ContentView>
