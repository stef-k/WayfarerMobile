<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:progress="clr-namespace:Syncfusion.Maui.Toolkit.ProgressBar;assembly=Syncfusion.Maui.Toolkit"
             xmlns:vm="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:tileCache="clr-namespace:WayfarerMobile.Services.TileCache"
             x:Class="WayfarerMobile.Shared.Controls.CacheStatusSheet"
             x:Name="Root"
             x:DataType="vm:CacheStatusViewModel">

    <!-- Root grid visibility controlled by code-behind -->
    <Grid x:Name="SheetContainer" IsVisible="False">
        <!-- Semi-transparent backdrop (tap to close) -->
        <Grid BackgroundColor="#40000000">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnBackdropTapped" />
            </Grid.GestureRecognizers>
        </Grid>

        <!-- Slide-up sheet content -->
        <Border VerticalOptions="End"
                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                StrokeThickness="0">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="16,16,0,0" />
            </Border.StrokeShape>

            <Grid RowDefinitions="Auto,*,Auto"
                  MaximumHeightRequest="600"
                  BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

                <!-- Grabber handle -->
                <BoxView HorizontalOptions="Center"
                         VerticalOptions="Start"
                         WidthRequest="40"
                         HeightRequest="4"
                         CornerRadius="2"
                         Margin="0,8,0,0"
                         Color="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray600}}" />

                <!-- Header Section -->
                <Grid Grid.Row="0" Padding="16,20,16,12" ColumnDefinitions="*,Auto,Auto">

                    <!-- Title -->
                    <Label Text="Cache Status"
                           Style="{StaticResource SubHeadline}"
                           FontAttributes="Bold"
                           VerticalOptions="Center" />

                    <!-- Refresh Button -->
                    <Button Grid.Column="1"
                            Text="↻"
                            FontSize="18"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            CornerRadius="18"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Primary}"
                            Command="{Binding LoadDataCommand}"
                            IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}" />

                    <!-- Close Button -->
                    <Button Grid.Column="2"
                            Text="✕"
                            FontSize="16"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            CornerRadius="18"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource TextSecondary}"
                            Clicked="OnCloseClicked" />
                </Grid>

                <!-- Scrollable Content -->
                <ScrollView Grid.Row="1" Padding="16,0">
                    <VerticalStackLayout Spacing="16">

                        <!-- Summary Card -->
                        <Border Padding="16"
                                StrokeThickness="0"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12" />
                            </Border.StrokeShape>

                            <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="12">
                                <!-- Status + Coverage -->
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    <Ellipse WidthRequest="16"
                                             HeightRequest="16"
                                             Fill="{Binding StatusColor}"
                                             VerticalOptions="Center" />
                                    <VerticalStackLayout Grid.Column="1" Margin="12,0,0,0" VerticalOptions="Center">
                                        <Label Text="{Binding StatusText}"
                                               FontSize="16"
                                               FontAttributes="Bold" />
                                        <Label Text="{Binding NetworkStatusText}"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                    </VerticalStackLayout>
                                    <Label Grid.Column="2"
                                           Text="{Binding CoveragePercentText}"
                                           FontSize="28"
                                           FontAttributes="Bold"
                                           TextColor="{Binding StatusColor}"
                                           VerticalOptions="Center" />
                                </Grid>

                                <!-- Coverage Progress Bar -->
                                <progress:SfLinearProgressBar Grid.Row="1"
                                                              Progress="{Binding CoverageProgress}"
                                                              Minimum="0"
                                                              Maximum="100"
                                                              HeightRequest="8"
                                                              TrackFill="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                                              ProgressFill="{Binding StatusColor}"
                                                              SegmentGapWidth="0"
                                                              TrackCornerRadius="4"
                                                              ProgressCornerRadius="4" />

                                <!-- Tiles Summary -->
                                <Grid Grid.Row="2" ColumnDefinitions="*,*">
                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="Cached Tiles"
                                               FontSize="11"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                        <Label FontSize="14" FontAttributes="Bold">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span Text="{Binding CachedTiles}" />
                                                    <Span Text=" / " TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                    <Span Text="{Binding TotalTiles}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </VerticalStackLayout>
                                    <VerticalStackLayout Grid.Column="1" Spacing="2">
                                        <Label Text="Breakdown"
                                               FontSize="11"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                        <Label Text="{Binding TilesBreakdownText}"
                                               FontSize="14"
                                               FontAttributes="Bold" />
                                    </VerticalStackLayout>
                                </Grid>
                            </Grid>
                        </Border>

                        <!-- Map Overlay Toggle -->
                        <Border Padding="12"
                                StrokeThickness="1"
                                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                BackgroundColor="Transparent">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>

                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <Label Text="Show Coverage on Map"
                                       FontSize="14"
                                       VerticalOptions="Center" />
                                <Switch Grid.Column="2"
                                        IsToggled="{Binding IsOverlayEnabled}"
                                        OnColor="{StaticResource Primary}"
                                        VerticalOptions="Center">
                                    <Switch.Behaviors>
                                        <EventToCommandBehavior EventName="Toggled"
                                                                Command="{Binding ToggleOverlayCommand}" />
                                    </Switch.Behaviors>
                                </Switch>
                            </Grid>
                        </Border>

                        <!-- Cache Sizes -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Cache Storage"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />

                            <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="8">
                                <Label Text="Local Area"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding LocalSizeText}" FontAttributes="Bold" />

                                <Label Grid.Row="1" Text="Live Cache"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Row="1" Grid.Column="1" Text="{Binding LiveSizeText}" />

                                <Label Grid.Row="2" Text="Trip Cache"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Row="2" Grid.Column="1" Text="{Binding TripSizeText}" />

                                <BoxView Grid.Row="3" Grid.ColumnSpan="2" HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />
                            </Grid>

                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Total" FontAttributes="Bold" />
                                <Label Grid.Column="1" Text="{Binding TotalSizeText}" FontAttributes="Bold" />
                            </Grid>
                        </VerticalStackLayout>

                        <!-- Trip Info (if applicable) -->
                        <VerticalStackLayout Spacing="4" IsVisible="{Binding HasActiveTrip}">
                            <Label Text="Active Trip"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                            <Label Text="{Binding ActiveTripName}"
                                   FontSize="14" />
                        </VerticalStackLayout>

                        <Label Text="{Binding DownloadedTripsText}"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                               IsVisible="{Binding DownloadedTripCount, Converter={StaticResource IntToBoolConverter}}" />

                        <!-- Zoom Level Coverage -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Coverage by Zoom Level"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />

                            <CollectionView ItemsSource="{Binding ZoomCoverage}"
                                            HeightRequest="180">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="tileCache:ZoomCoverageStatus">
                                        <Grid ColumnDefinitions="50,*,50,16" ColumnSpacing="8" Padding="0,4">
                                            <Label Text="{Binding ZoomLabel}"
                                                   FontSize="13"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center" />

                                            <progress:SfLinearProgressBar Grid.Column="1"
                                                                          Progress="{Binding CoveragePercent, Converter={StaticResource PercentToProgressConverter}}"
                                                                          Minimum="0"
                                                                          Maximum="100"
                                                                          HeightRequest="6"
                                                                          TrackFill="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                                                          ProgressFill="{Binding IndicatorColor}"
                                                                          SegmentGapWidth="0"
                                                                          TrackCornerRadius="3"
                                                                          ProgressCornerRadius="3"
                                                                          VerticalOptions="Center" />

                                            <Label Grid.Column="2"
                                                   Text="{Binding FormattedPercent}"
                                                   FontSize="12"
                                                   HorizontalOptions="End"
                                                   VerticalOptions="Center" />

                                            <Ellipse Grid.Column="3"
                                                     WidthRequest="10"
                                                     HeightRequest="10"
                                                     Fill="{Binding IndicatorColor}"
                                                     VerticalOptions="Center"
                                                     HorizontalOptions="Center" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>

                        <!-- Spacer for safe area -->
                        <BoxView HeightRequest="20" Color="Transparent" />

                    </VerticalStackLayout>
                </ScrollView>

                <!-- Footer Actions -->
                <Grid Grid.Row="2"
                      Padding="16,8,16,16"
                      BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

                    <Button Text="Clear All Cache"
                            Command="{Binding ClearCacheCommand}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                            TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource TextPrimaryDark}}"
                            FontSize="14"
                            HeightRequest="44"
                            CornerRadius="8"
                            IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}" />
                </Grid>

                <!-- Loading Overlay -->
                <Grid Grid.RowSpan="3"
                      BackgroundColor="{AppThemeBinding Light=#80FFFFFF, Dark=#80000000}"
                      IsVisible="{Binding IsBusy}">
                    <ActivityIndicator IsRunning="{Binding IsBusy}"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       HeightRequest="40"
                                       WidthRequest="40"
                                       Color="{StaticResource Primary}" />
                </Grid>

            </Grid>
        </Border>
    </Grid>

</ContentView>
