<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.syncfusion.com/maui/toolkit"
             x:Class="WayfarerMobile.Shared.Controls.SearchableDropdown"
             x:Name="thisControl">

    <Grid RowDefinitions="Auto,Auto">
        <!-- Text Input with floating label -->
        <toolkit:SfTextInputLayout x:Name="inputLayout"
                                   Hint="{Binding Placeholder, Source={x:Reference thisControl}}"
                                   ContainerType="Outlined"
                                   ShowHelperText="False"
                                   EnableFloating="True"
                                   ContainerBackground="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource OffBlack}}"
                                   Stroke="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray600}}"
                                   FocusedStroke="{StaticResource Primary}">
            <Entry x:Name="searchEntry"
                   Text="{Binding SearchText, Source={x:Reference thisControl}, Mode=TwoWay}"
                   Placeholder=""
                   Focused="OnEntryFocused"
                   Unfocused="OnEntryUnfocused"
                   TextChanged="OnSearchTextChanged"
                   ReturnType="Done"
                   ClearButtonVisibility="WhileEditing" />
        </toolkit:SfTextInputLayout>

        <!-- Dropdown arrow button -->
        <Button x:Name="dropdownButton"
                Text="â–¼"
                FontSize="10"
                WidthRequest="36"
                HeightRequest="36"
                Padding="0"
                Margin="0,8,8,0"
                BackgroundColor="Transparent"
                TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                HorizontalOptions="End"
                VerticalOptions="Center"
                Clicked="OnDropdownButtonClicked" />

        <!-- Dropdown list overlay -->
        <Border x:Name="dropdownBorder"
                Grid.Row="1"
                IsVisible="False"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}"
                StrokeThickness="1"
                Margin="0,-4,0,0"
                ZIndex="100"
                MaximumHeightRequest="200">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="0,0,8,8" />
            </Border.StrokeShape>
            <Border.Shadow>
                <Shadow Brush="{StaticResource Gray900}"
                        Offset="0,4"
                        Radius="8"
                        Opacity="0.2" />
            </Border.Shadow>

            <CollectionView x:Name="suggestionsList"
                            ItemsSource="{Binding FilteredItems, Source={x:Reference thisControl}}"
                            SelectionMode="Single"
                            SelectionChanged="OnSuggestionSelected">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="16,12" BackgroundColor="Transparent">
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnItemTapped" />
                            </Grid.GestureRecognizers>
                            <Label Text="{Binding}"
                                   FontSize="14"
                                   VerticalOptions="Center" />
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup Name="CommonStates">
                                    <VisualState Name="Normal">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="Transparent" />
                                        </VisualState.Setters>
                                    </VisualState>
                                    <VisualState Name="Selected">
                                        <VisualState.Setters>
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <Grid Padding="16,12">
                        <Label Text="No matches found"
                               FontSize="14"
                               TextColor="{StaticResource Gray500}"
                               HorizontalOptions="Center" />
                    </Grid>
                </CollectionView.EmptyView>
            </CollectionView>
        </Border>
    </Grid>
</ContentView>
