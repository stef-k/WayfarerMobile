<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:services="clr-namespace:WayfarerMobile.Services"
             xmlns:sfExpander="clr-namespace:Syncfusion.Maui.Toolkit.Expander;assembly=Syncfusion.Maui.Toolkit"
             x:Class="WayfarerMobile.Views.DiagnosticsPage"
             x:DataType="vm:DiagnosticsViewModel"
             Title="{Binding Title}">

    <Grid>
        <ScrollView>
            <VerticalStackLayout Padding="15" Spacing="10">

                <!-- Health Status Card -->
                <Frame Padding="15" CornerRadius="10">
                    <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="10">
                        <Label Grid.Row="0" Grid.Column="0" Text="System Health" FontSize="18" FontAttributes="Bold" />
                        <Label Grid.Row="0" Grid.Column="1" Text="{Binding HealthStatus}" TextColor="{Binding HealthStatusColor}" FontSize="18" FontAttributes="Bold" />
                        <Grid Grid.Row="1" Grid.ColumnSpan="2" RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,*" RowSpacing="8" ColumnSpacing="15">
                            <HorizontalStackLayout Grid.Row="0" Grid.Column="0" Spacing="5">
                                <Label Text="FG Location:" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Text="{Binding HasForegroundLocation, Converter={StaticResource BoolToCheckConverter}}" FontSize="12" />
                            </HorizontalStackLayout>
                            <HorizontalStackLayout Grid.Row="0" Grid.Column="1" Spacing="5">
                                <Label Text="BG Location:" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Text="{Binding HasBackgroundLocation, Converter={StaticResource BoolToCheckConverter}}" FontSize="12" />
                            </HorizontalStackLayout>
                            <HorizontalStackLayout Grid.Row="1" Grid.Column="0" Spacing="5">
                                <Label Text="GPS:" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Text="{Binding IsGpsRunning, Converter={StaticResource BoolToCheckConverter}}" FontSize="12" />
                            </HorizontalStackLayout>
                            <HorizontalStackLayout Grid.Row="1" Grid.Column="1" Spacing="5">
                                <Label Text="Server:" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Text="{Binding HasServerConfig, Converter={StaticResource BoolToCheckConverter}}" FontSize="12" />
                            </HorizontalStackLayout>
                            <HorizontalStackLayout Grid.Row="2" Grid.Column="0" Spacing="5">
                                <Label Text="Tracking:" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Text="{Binding IsTrackingEnabled, Converter={StaticResource BoolToCheckConverter}}" FontSize="12" />
                            </HorizontalStackLayout>
                            <HorizontalStackLayout Grid.Row="2" Grid.Column="1" Spacing="5">
                                <Label Text="Network:" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Text="{Binding HasNetwork, Converter={StaticResource BoolToCheckConverter}}" FontSize="12" />
                            </HorizontalStackLayout>
                        </Grid>
                    </Grid>
                </Frame>

                <!-- Location Queue Section -->
                <sfExpander:SfExpander IsExpanded="True">
                    <sfExpander:SfExpander.Header>
                        <Grid HeightRequest="48" Padding="10,0" ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" Text="Location Queue" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                            <Button Grid.Column="1" Text="Refresh" Command="{Binding RefreshQueueCommand}" Style="{StaticResource DarkButton}" HeightRequest="30" Padding="10,0" FontSize="12" VerticalOptions="Center" />
                        </Grid>
                    </sfExpander:SfExpander.Header>
                    <sfExpander:SfExpander.Content>
                        <VerticalStackLayout Padding="15" Spacing="8">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Pending:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding PendingLocations}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Synced:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding SyncedLocations}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Failed:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding FailedLocations}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Oldest Pending:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding OldestPendingAge}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Last Sync:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding LastSyncTime}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Status:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding QueueHealthStatus}" />
                            </Grid>
                            <BoxView HeightRequest="1" Margin="0,8" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />
                            <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="8">
                                <Button Grid.Column="0"
                                        Text="Export"
                                        Command="{Binding ExportQueueCommand}"
                                        Style="{StaticResource DarkButton}"
                                        HeightRequest="36"
                                        FontSize="12" />
                                <Button Grid.Column="1"
                                        Text="Clear Synced"
                                        Command="{Binding ClearSyncedCommand}"
                                        Style="{StaticResource DarkButton}"
                                        HeightRequest="36"
                                        FontSize="12" />
                                <Button Grid.Column="2"
                                        Text="Clear All"
                                        Command="{Binding ClearAllQueueCommand}"
                                        Style="{StaticResource DangerButton}"
                                        HeightRequest="36"
                                        FontSize="12" />
                            </Grid>
                            <Label Text="Warning: Clearing pending locations will permanently delete data that hasn't been synced to the server."
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>
                    </sfExpander:SfExpander.Content>
                </sfExpander:SfExpander>

                <!-- Queue Entries (like Recent Logs) -->
                <sfExpander:SfExpander IsExpanded="False">
                    <sfExpander:SfExpander.Header>
                        <Grid HeightRequest="48" Padding="10,0" ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" Text="Queue Entries" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                            <Button Grid.Column="1" Text="Refresh" Command="{Binding RefreshQueueCommand}" Style="{StaticResource DarkButton}" HeightRequest="30" Padding="10,0" FontSize="12" VerticalOptions="Center" />
                        </Grid>
                    </sfExpander:SfExpander.Header>
                    <sfExpander:SfExpander.Content>
                        <ScrollView HeightRequest="300" Orientation="Both">
                            <Label Text="{Binding QueueDetails}" FontSize="10" Padding="15" />
                        </ScrollView>
                    </sfExpander:SfExpander.Content>
                </sfExpander:SfExpander>

                <!-- Tile Cache Section -->
                <sfExpander:SfExpander IsExpanded="True">
                    <sfExpander:SfExpander.Header>
                        <Grid HeightRequest="48" Padding="10,0" ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" Text="Tile Cache" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                            <Label Grid.Column="1" Text="{Binding CacheHealthStatus}" FontSize="14" VerticalOptions="Center" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </Grid>
                    </sfExpander:SfExpander.Header>
                    <sfExpander:SfExpander.Content>
                        <VerticalStackLayout Padding="15" Spacing="8">
                            <Label Text="Live Cache" FontAttributes="Bold" FontSize="13" />
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Tiles:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding LiveTileCount}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Usage:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding LiveCacheUsage}" />
                            </Grid>
                            <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />
                            <Label Text="Trip Cache" FontAttributes="Bold" FontSize="13" />
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Tiles:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding TripTileCount}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Usage:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding TripCacheUsage}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Trips:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding DownloadedTripCount}" />
                            </Grid>
                            <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Total:" FontAttributes="Bold" />
                                <Label Grid.Column="1" Text="{Binding TotalCacheSize}" FontAttributes="Bold" />
                            </Grid>
                        </VerticalStackLayout>
                    </sfExpander:SfExpander.Content>
                </sfExpander:SfExpander>

                <!-- Tracking Section -->
                <sfExpander:SfExpander IsExpanded="True">
                    <sfExpander:SfExpander.Header>
                        <Grid HeightRequest="48" Padding="10,0">
                            <Label Text="Tracking" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                        </Grid>
                    </sfExpander:SfExpander.Header>
                    <sfExpander:SfExpander.Content>
                        <VerticalStackLayout Padding="15" Spacing="8">
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="State:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding TrackingState}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Mode:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding PerformanceMode}" />
                            </Grid>
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Thresholds:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding TrackingThresholds}" />
                            </Grid>
                            <Label Text="Last Location:" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Label Text="{Binding LastLocationInfo}" FontSize="11" />
                        </VerticalStackLayout>
                    </sfExpander:SfExpander.Content>
                </sfExpander:SfExpander>

                <!-- Navigation Section -->
                <sfExpander:SfExpander IsExpanded="False">
                    <sfExpander:SfExpander.Header>
                        <Grid HeightRequest="48" Padding="10,0">
                            <Label Text="Navigation" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                        </Grid>
                    </sfExpander:SfExpander.Header>
                    <sfExpander:SfExpander.Content>
                        <VerticalStackLayout Padding="15" Spacing="8">
                            <Label Text="{Binding CachedRouteInfo}" FontSize="12" />
                        </VerticalStackLayout>
                    </sfExpander:SfExpander.Content>
                </sfExpander:SfExpander>

                <!-- System Information -->
                <sfExpander:SfExpander IsExpanded="False">
                    <sfExpander:SfExpander.Header>
                        <Grid HeightRequest="48" Padding="10,0">
                            <Label Text="System" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                        </Grid>
                    </sfExpander:SfExpander.Header>
                    <sfExpander:SfExpander.Content>
                        <VerticalStackLayout Padding="15" Spacing="8">
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Platform:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding Platform}" />
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="OS:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding OsVersion}" />
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Device:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding DeviceInfo}" />
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="App:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding AppVersion}" />
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Battery:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding BatteryStatus}" />
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10" IsVisible="{Binding IsEnergySaverOn}">
                                <Label Grid.Column="0" Text="Saver:" TextColor="Orange" />
                                <Label Grid.Column="1" Text="ON" TextColor="Orange" />
                            </Grid>
                        </VerticalStackLayout>
                    </sfExpander:SfExpander.Content>
                </sfExpander:SfExpander>

                <!-- Performance Section -->
                <sfExpander:SfExpander IsExpanded="False">
                    <sfExpander:SfExpander.Header>
                        <Grid HeightRequest="48" Padding="10,0">
                            <Label Text="Performance" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                        </Grid>
                    </sfExpander:SfExpander.Header>
                    <sfExpander:SfExpander.Content>
                        <VerticalStackLayout Padding="15" Spacing="8">
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Memory:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding MemoryUsage}" />
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Session:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding SessionDuration}" />
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="Ops:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding TotalOperations}" />
                            </Grid>
                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="10">
                                <Label Grid.Column="0" Text="GC:" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                <Label Grid.Column="1" Text="{Binding GcCollections}" />
                            </Grid>
                        </VerticalStackLayout>
                    </sfExpander:SfExpander.Content>
                </sfExpander:SfExpander>

                <!-- Log Files -->
                <sfExpander:SfExpander IsExpanded="False">
                    <sfExpander:SfExpander.Header>
                        <Grid HeightRequest="48" Padding="10,0">
                            <Label Text="Log Files" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                        </Grid>
                    </sfExpander:SfExpander.Header>
                    <sfExpander:SfExpander.Content>
                        <VerticalStackLayout Padding="15" Spacing="8">
                            <CollectionView ItemsSource="{Binding LogFiles}" HeightRequest="200">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="services:LogFileInfo">
                                        <Border Padding="8" Margin="0,2" StrokeThickness="0" BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}">
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="10">
                                                <VerticalStackLayout Grid.Column="0" Spacing="2">
                                                    <Label Text="{Binding FileName}" FontSize="13" FontAttributes="Bold" />
                                                    <HorizontalStackLayout Spacing="10">
                                                        <Label Text="{Binding SizeText}" FontSize="11" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                        <Label Text="{Binding LastModified, StringFormat='{0:MMM d, HH:mm}'}" FontSize="11" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                                    </HorizontalStackLayout>
                                                </VerticalStackLayout>
                                                <Button Grid.Column="1"
                                                        Text="Share"
                                                        FontSize="11"
                                                        Padding="10,4"
                                                        HeightRequest="32"
                                                        CornerRadius="4"
                                                        BackgroundColor="{StaticResource Primary}"
                                                        TextColor="White"
                                                        VerticalOptions="Center"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DiagnosticsViewModel}}, Path=ShareLogFileCommand}"
                                                        CommandParameter="{Binding .}" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                                <CollectionView.EmptyView>
                                    <Label Text="No log files" HorizontalOptions="Center" TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                </CollectionView.EmptyView>
                            </CollectionView>
                        </VerticalStackLayout>
                    </sfExpander:SfExpander.Content>
                </sfExpander:SfExpander>

                <!-- Recent Logs -->
                <sfExpander:SfExpander IsExpanded="False">
                    <sfExpander:SfExpander.Header>
                        <Grid HeightRequest="48" Padding="10,0" ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0" Text="Recent Logs" FontSize="16" FontAttributes="Bold" VerticalOptions="Center" />
                            <Button Grid.Column="1" Text="Refresh" Command="{Binding RefreshLogsCommand}" Style="{StaticResource DarkButton}" HeightRequest="30" Padding="10,0" FontSize="12" VerticalOptions="Center" />
                        </Grid>
                    </sfExpander:SfExpander.Header>
                    <sfExpander:SfExpander.Content>
                        <ScrollView HeightRequest="300" Orientation="Both">
                            <Label Text="{Binding RecentLogs}" FontSize="10" Padding="15" />
                        </ScrollView>
                    </sfExpander:SfExpander.Content>
                </sfExpander:SfExpander>

                <!-- Actions -->
                <VerticalStackLayout Spacing="10" Padding="0,10">
                    <Button Text="Generate and Share Report" Command="{Binding ShareReportCommand}" HeightRequest="44" />
                    <Button Text="Copy Report to Clipboard" Command="{Binding CopyReportCommand}" Style="{StaticResource DarkButton}" HeightRequest="44" />
                    <Button Text="Refresh Status" Command="{Binding LoadDataCommand}" Style="{StaticResource DarkButton}" HeightRequest="44" />
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Loading Overlay -->
        <Grid BackgroundColor="{AppThemeBinding Light=#80FFFFFF, Dark=#80000000}" IsVisible="{Binding IsLoading}">
            <ActivityIndicator IsRunning="{Binding IsLoading}" HorizontalOptions="Center" VerticalOptions="Center" HeightRequest="50" WidthRequest="50" />
        </Grid>
    </Grid>

</ContentPage>
