<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:mapsui="clr-namespace:Mapsui.UI.Maui;assembly=Mapsui.UI.Maui"
             xmlns:bottomSheet="clr-namespace:Syncfusion.Maui.Toolkit.BottomSheet;assembly=Syncfusion.Maui.Toolkit"
             xmlns:sys="clr-namespace:System;assembly=netstandard"
             x:Class="WayfarerMobile.Views.TimelinePage"
             x:DataType="viewmodels:TimelineViewModel"
             Title="Timeline">

    <Grid>
        <bottomSheet:SfBottomSheet x:Name="BottomSheet"
                                   IsOpen="{Binding IsLocationSheetOpen, Mode=TwoWay}"
                                   State="FullExpanded"
                                   AllowedState="All"
                                   HalfExpandedRatio="0.7"
                                   FullExpandedRatio="0.95"
                                   EnableSwiping="True"
                                   IsModal="True"
                                   ShowGrabber="True"
                                   GrabberWidth="40"
                                   GrabberHeight="4"
                                   CornerRadius="16"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

            <bottomSheet:SfBottomSheet.Content>
                <Grid RowDefinitions="Auto,*">
                    <!-- Hidden DatePicker (triggered programmatically) -->
                    <DatePicker x:Name="HiddenDatePicker"
                                Date="{Binding SelectedDate}"
                                MaximumDate="{x:Static sys:DateTime.Today}"
                                IsVisible="False"
                                DateSelected="OnDateSelected" />

                    <!-- Date Navigation Bar (inside SfBottomSheet.Content to avoid blank page) -->
                    <Border Grid.Row="0"
                            Padding="8,4"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                            StrokeThickness="0">
                        <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                            <!-- Previous Day Button -->
                            <ImageButton Grid.Column="0"
                                         Source="arrow_left.png"
                                         WidthRequest="40"
                                         HeightRequest="40"
                                         Padding="8"
                                         CornerRadius="8"
                                         BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                         Command="{Binding PreviousCommand}" />

                            <!-- Date Button (shows current date, opens picker on tap) -->
                            <Button Grid.Column="1"
                                    Text="{Binding DateButtonText}"
                                    FontSize="14"
                                    HeightRequest="40"
                                    Padding="16,0"
                                    CornerRadius="8"
                                    HorizontalOptions="Center"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    Clicked="OnDateButtonClicked" />

                            <!-- Next Day Button (disabled on today) -->
                            <ImageButton Grid.Column="2"
                                         Source="arrow_right.png"
                                         WidthRequest="40"
                                         HeightRequest="40"
                                         Padding="8"
                                         CornerRadius="8"
                                         BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                         Command="{Binding NextCommand}"
                                         IsEnabled="{Binding CanGoNext}" />
                        </Grid>
                    </Border>

                    <!-- Map Control -->
                    <mapsui:MapControl Grid.Row="1"
                                       x:Name="MapControl"
                                       Map="{Binding Map}"
                                       HorizontalOptions="Fill"
                                       VerticalOptions="Fill" />
                </Grid>
            </bottomSheet:SfBottomSheet.Content>

            <bottomSheet:SfBottomSheet.BottomSheetContent>
                <Grid RowDefinitions="Auto,*,Auto" BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                    <!-- Header with close button -->
                    <Grid Grid.Row="0" Padding="16,12" ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding SelectedLocation.TimeText}"
                                   Style="{StaticResource Headline}"
                                   FontAttributes="Bold" />
                            <Label Text="{Binding SelectedLocation.DateText}"
                                   Style="{StaticResource Caption}"
                                   TextColor="{StaticResource TextSecondary}" />
                        </VerticalStackLayout>
                        <Button Grid.Column="1"
                                Text="âœ•"
                                FontSize="16"
                                WidthRequest="36"
                                HeightRequest="36"
                                Padding="0"
                                CornerRadius="18"
                                BackgroundColor="Transparent"
                                TextColor="{StaticResource TextSecondary}"
                                Command="{Binding CloseLocationSheetCommand}" />
                    </Grid>

                    <!-- Content -->
                    <ScrollView Grid.Row="1" Padding="16,0">
                        <VerticalStackLayout Spacing="12">
                            <Frame Padding="12"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}"
                                   BorderColor="Transparent"
                                   CornerRadius="8"
                                   HasShadow="False">
                                <VerticalStackLayout Spacing="2">
                                    <Label Text="Coordinates" Style="{StaticResource Caption}" FontAttributes="Bold" TextColor="{StaticResource TextSecondary}" />
                                    <Label Text="{Binding SelectedLocation.CoordinatesText}" Style="{StaticResource Body}" />
                                </VerticalStackLayout>
                            </Frame>

                            <Frame Padding="12"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}"
                                   BorderColor="Transparent"
                                   CornerRadius="8"
                                   HasShadow="False">
                                <VerticalStackLayout Spacing="2">
                                    <Label Text="Accuracy" Style="{StaticResource Caption}" FontAttributes="Bold" TextColor="{StaticResource TextSecondary}" />
                                    <Label Text="{Binding SelectedLocation.AccuracyText}" Style="{StaticResource Body}" />
                                </VerticalStackLayout>
                            </Frame>

                            <Frame Padding="12"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}"
                                   BorderColor="Transparent"
                                   CornerRadius="8"
                                   HasShadow="False"
                                   IsVisible="{Binding SelectedLocation.HasSpeed}">
                                <VerticalStackLayout Spacing="2">
                                    <Label Text="Speed" Style="{StaticResource Caption}" FontAttributes="Bold" TextColor="{StaticResource TextSecondary}" />
                                    <Label Text="{Binding SelectedLocation.SpeedText}" Style="{StaticResource Body}" />
                                </VerticalStackLayout>
                            </Frame>

                            <Frame Padding="12"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}"
                                   BorderColor="Transparent"
                                   CornerRadius="8"
                                   HasShadow="False"
                                   IsVisible="{Binding SelectedLocation.HasAltitude}">
                                <VerticalStackLayout Spacing="2">
                                    <Label Text="Altitude" Style="{StaticResource Caption}" FontAttributes="Bold" TextColor="{StaticResource TextSecondary}" />
                                    <Label Text="{Binding SelectedLocation.AltitudeText}" Style="{StaticResource Body}" />
                                </VerticalStackLayout>
                            </Frame>

                            <Frame Padding="12"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}"
                                   BorderColor="Transparent"
                                   CornerRadius="8"
                                   HasShadow="False"
                                   IsVisible="{Binding SelectedLocation.HasAddress}">
                                <VerticalStackLayout Spacing="2">
                                    <Label Text="Address" Style="{StaticResource Caption}" FontAttributes="Bold" TextColor="{StaticResource TextSecondary}" />
                                    <Label Text="{Binding SelectedLocation.Address}" Style="{StaticResource Body}" />
                                </VerticalStackLayout>
                            </Frame>
                        </VerticalStackLayout>
                    </ScrollView>

                    <!-- Action Buttons -->
                    <ScrollView Grid.Row="2" Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
                        <HorizontalStackLayout Padding="16,12" Spacing="8">
                            <Button Text="Maps"
                                    Command="{Binding OpenInMapsCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    FontSize="14"
                                    HeightRequest="40"
                                    CornerRadius="8"
                                    Padding="16,0" />
                            <Button Text="Wikipedia"
                                    Command="{Binding SearchWikipediaCommand}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                    TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource TextPrimaryDark}}"
                                    FontSize="14"
                                    HeightRequest="40"
                                    CornerRadius="8"
                                    Padding="16,0" />
                            <Button Text="Copy"
                                    Command="{Binding CopyCoordinatesCommand}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                    TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource TextPrimaryDark}}"
                                    FontSize="14"
                                    HeightRequest="40"
                                    CornerRadius="8"
                                    Padding="16,0" />
                            <Button Text="Share"
                                    Command="{Binding ShareLocationCommand}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                    TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource TextPrimaryDark}}"
                                    FontSize="14"
                                    HeightRequest="40"
                                    CornerRadius="8"
                                    Padding="16,0" />
                            <Button Text="Edit"
                                    Clicked="OnEditLocationClicked"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                    TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource TextPrimaryDark}}"
                                    FontSize="14"
                                    HeightRequest="40"
                                    CornerRadius="8"
                                    Padding="16,0" />
                        </HorizontalStackLayout>
                    </ScrollView>
                </Grid>
            </bottomSheet:SfBottomSheet.BottomSheetContent>
        </bottomSheet:SfBottomSheet>
    </Grid>
</ContentPage>
