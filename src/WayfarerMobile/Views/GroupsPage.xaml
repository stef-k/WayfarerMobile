<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:models="clr-namespace:WayfarerMobile.Core.Models;assembly=WayfarerMobile.Core"
             xmlns:mapsui="clr-namespace:Mapsui.UI.Maui;assembly=Mapsui.UI.Maui"
             xmlns:controls="clr-namespace:WayfarerMobile.Shared.Controls"
             xmlns:segmented="clr-namespace:Syncfusion.Maui.Toolkit.SegmentedControl;assembly=Syncfusion.Maui.Toolkit"
             xmlns:picker="clr-namespace:Syncfusion.Maui.Toolkit.Picker;assembly=Syncfusion.Maui.Toolkit"
             xmlns:sys="clr-namespace:System;assembly=netstandard"
             x:Class="WayfarerMobile.Views.GroupsPage"
             x:DataType="viewmodels:GroupsViewModel"
             Title="{Binding Title}"
             BackgroundColor="{StaticResource Background}">

    <Grid RowDefinitions="Auto,*">

        <!-- Not Configured Message -->
        <VerticalStackLayout Grid.Row="0" Grid.RowSpan="2"
                            IsVisible="{Binding IsConfigured, Converter={StaticResource InvertedBoolConverter}}"
                            VerticalOptions="Center"
                            HorizontalOptions="Center"
                            Spacing="16"
                            Padding="24">
            <Label Text="Not Configured"
                   FontSize="24"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center" />
            <Label Text="Please configure your server URL and API token in Settings to view your groups."
                   FontSize="14"
                   HorizontalTextAlignment="Center"
                   TextColor="{StaticResource Gray500}" />
        </VerticalStackLayout>

        <!-- Main Content (when configured) -->
        <Grid Grid.Row="0" Grid.RowSpan="2"
              IsVisible="{Binding IsConfigured}"
              RowDefinitions="Auto,Auto,Auto,*">

            <!-- Group Selector -->
            <Frame Grid.Row="0"
                   Padding="12"
                   Margin="8"
                   CornerRadius="8"
                   BorderColor="{StaticResource Gray200}">
                <Grid ColumnDefinitions="*,Auto">
                    <Picker Title="Select Group"
                            ItemsSource="{Binding Groups}"
                            SelectedItem="{Binding SelectedGroup}"
                            ItemDisplayBinding="{Binding Name}"
                            IsEnabled="{Binding IsLoadingGroups, Converter={StaticResource InvertedBoolConverter}}" />

                    <ActivityIndicator Grid.Column="1"
                                      IsRunning="{Binding IsLoadingGroups}"
                                      IsVisible="{Binding IsLoadingGroups}"
                                      WidthRequest="24"
                                      HeightRequest="24"
                                      Color="{StaticResource Primary}" />

                    <Button Grid.Column="1"
                            Text="â†»"
                            FontSize="18"
                            WidthRequest="44"
                            HeightRequest="44"
                            Padding="0"
                            Command="{Binding LoadGroupsCommand}"
                            IsVisible="{Binding IsLoadingGroups, Converter={StaticResource InvertedBoolConverter}}"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Primary}" />
                </Grid>
            </Frame>

            <!-- Date Navigation Header -->
            <Border Grid.Row="1"
                    BackgroundColor="{StaticResource Surface}"
                    Padding="8,12"
                    Margin="8,0"
                    StrokeThickness="0"
                    StrokeShape="RoundRectangle 8">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <!-- Previous Day Button -->
                    <Button Grid.Column="0"
                            Text="â—€"
                            Command="{Binding PreviousDayCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Primary}"
                            FontSize="18"
                            WidthRequest="40"
                            HeightRequest="40" />

                    <!-- Current Date (tappable to open date picker) -->
                    <VerticalStackLayout Grid.Column="1"
                                         HorizontalOptions="Center"
                                         VerticalOptions="Center"
                                         Spacing="2">
                        <VerticalStackLayout.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding OpenDatePickerCommand}" />
                        </VerticalStackLayout.GestureRecognizers>
                        <HorizontalStackLayout HorizontalOptions="Center" Spacing="6">
                            <Label Text="{Binding SelectedDateText}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center" />
                            <Label Text="ðŸ“…"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   TextColor="{StaticResource Primary}" />
                        </HorizontalStackLayout>
                        <!-- Live indicator when viewing today -->
                        <HorizontalStackLayout HorizontalOptions="Center"
                                               Spacing="4"
                                               IsVisible="{Binding IsToday}">
                            <Ellipse WidthRequest="8"
                                     HeightRequest="8"
                                     Fill="{StaticResource Success}"
                                     VerticalOptions="Center" />
                            <Label Text="Live"
                                   FontSize="11"
                                   TextColor="{StaticResource Success}"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <!-- Next Day / Today Button -->
                    <HorizontalStackLayout Grid.Column="2" Spacing="2">
                        <Button Text="Today"
                                Command="{Binding TodayCommand}"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"
                                FontSize="11"
                                Padding="10,6"
                                CornerRadius="14"
                                HeightRequest="28"
                                IsVisible="{Binding IsToday, Converter={StaticResource InvertedBoolConverter}}" />
                        <Button Text="â–¶"
                                Command="{Binding NextDayCommand}"
                                BackgroundColor="Transparent"
                                TextColor="{StaticResource Primary}"
                                FontSize="18"
                                WidthRequest="40"
                                HeightRequest="40" />
                    </HorizontalStackLayout>
                </Grid>
            </Border>

            <!-- View Toggle - Segmented Control -->
            <segmented:SfSegmentedControl Grid.Row="2"
                                          HorizontalOptions="Center"
                                          Margin="8,8"
                                          SelectedIndex="{Binding ViewModeIndex, Mode=TwoWay}"
                                          CornerRadius="16"
                                          SegmentCornerRadius="14"
                                          SegmentHeight="36"
                                          SegmentWidth="100"
                                          SelectionIndicatorSettings="{segmented:SelectionIndicatorSettings Background={StaticResource Primary}, SelectionIndicatorPlacement=Fill}">
                <segmented:SfSegmentedControl.ItemsSource>
                    <x:Array Type="{x:Type segmented:SfSegmentItem}">
                        <segmented:SfSegmentItem Text="List" />
                        <segmented:SfSegmentItem Text="Map" />
                    </x:Array>
                </segmented:SfSegmentedControl.ItemsSource>
            </segmented:SfSegmentedControl>

            <!-- List View -->
            <Grid Grid.Row="3" IsVisible="{Binding IsListView}">
                <!-- Shimmer Loading Placeholder -->
                <controls:ShimmerLoadingView IsActive="{Binding IsLoadingMembers}"
                                             IsVisible="{Binding IsLoadingMembers}" />

                <RefreshView Command="{Binding LoadMembersCommand}"
                            IsRefreshing="{Binding IsLoadingMembers}"
                            IsVisible="{Binding IsLoadingMembers, Converter={StaticResource InvertedBoolConverter}}">
                <CollectionView ItemsSource="{Binding Members}"
                               SelectionMode="None"
                               Margin="8,0">

                    <CollectionView.EmptyView>
                        <VerticalStackLayout VerticalOptions="Center"
                                            HorizontalOptions="Center"
                                            Spacing="8"
                                            Padding="24">
                            <Label Text="{Binding HasSelectedGroup, Converter={StaticResource BoolToTextConverter}, ConverterParameter='No members found|Select a group to see members'}"
                                   FontSize="16"
                                   TextColor="{StaticResource Gray500}"
                                   HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:GroupMember">
                            <Frame Margin="0,4"
                                   Padding="12"
                                   CornerRadius="8"
                                   BorderColor="{StaticResource Gray200}">
                                <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto">

                                    <!-- Color indicator -->
                                    <BoxView Grid.RowSpan="2"
                                            WidthRequest="8"
                                            HeightRequest="44"
                                            CornerRadius="4"
                                            Color="{Binding ColorHex}"
                                            VerticalOptions="Center" />

                                    <!-- Name and Role -->
                                    <VerticalStackLayout Grid.Column="1" Margin="12,0,0,0">
                                        <HorizontalStackLayout Spacing="8">
                                            <Label Text="{Binding DisplayText}"
                                                   FontSize="16"
                                                   FontAttributes="Bold" />
                                            <Label Text="(You)"
                                                   FontSize="14"
                                                   TextColor="{StaticResource Primary}"
                                                   IsVisible="{Binding IsSelf}" />
                                        </HorizontalStackLayout>
                                        <Label Text="{Binding GroupRole}"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray500}" />
                                    </VerticalStackLayout>

                                    <!-- Location Info -->
                                    <VerticalStackLayout Grid.Column="1"
                                                        Grid.Row="1"
                                                        Margin="12,4,0,0"
                                                        IsVisible="{Binding LastLocation, Converter={StaticResource IsNotNullConverter}}">
                                        <Label Text="{Binding LastLocation.Address, StringFormat='ðŸ“ {0}'}"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="1" />
                                        <Label FontSize="11"
                                               TextColor="{StaticResource Gray500}">
                                            <Label.Text>
                                                <Binding Path="LastLocation.Timestamp"
                                                        StringFormat="{}{0:MMM dd, HH:mm}" />
                                            </Label.Text>
                                        </Label>
                                    </VerticalStackLayout>

                                    <!-- Live indicator -->
                                    <Frame Grid.Column="2"
                                          Grid.RowSpan="2"
                                          VerticalOptions="Center"
                                          Padding="8,4"
                                          CornerRadius="12"
                                          IsVisible="{Binding LastLocation.IsLive}"
                                          BackgroundColor="{StaticResource Success}">
                                        <Label Text="LIVE"
                                               FontSize="10"
                                               FontAttributes="Bold"
                                               TextColor="White" />
                                    </Frame>

                                    <!-- Offline indicator -->
                                    <Label Grid.Column="2"
                                          Grid.RowSpan="2"
                                          Text="Offline"
                                          FontSize="12"
                                          TextColor="{StaticResource Gray400}"
                                          VerticalOptions="Center"
                                          IsVisible="{Binding LastLocation, Converter={StaticResource IsNullConverter}}" />

                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                </RefreshView>
            </Grid>

            <!-- Map View -->
            <Grid Grid.Row="3"
                  IsVisible="{Binding IsMapView}">
                <mapsui:MapControl Map="{Binding Map}" />

                <!-- Member Legend Overlay -->
                <Frame Margin="8"
                       Padding="8"
                       CornerRadius="8"
                       VerticalOptions="End"
                       HorizontalOptions="Start"
                       BackgroundColor="#E0FFFFFF"
                       BorderColor="{StaticResource Gray300}"
                       MaximumWidthRequest="200">
                    <CollectionView ItemsSource="{Binding Members}"
                                   SelectionMode="None"
                                   MaximumHeightRequest="200">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:GroupMember">
                                <HorizontalStackLayout Spacing="8" Padding="4,2">
                                    <Ellipse WidthRequest="12"
                                             HeightRequest="12"
                                             Fill="{Binding ColorHex}"
                                             VerticalOptions="Center" />
                                    <Label Text="{Binding DisplayText}"
                                           FontSize="12"
                                           VerticalOptions="Center"
                                           LineBreakMode="TailTruncation" />
                                    <Label Text="â—"
                                           FontSize="8"
                                           TextColor="{StaticResource Success}"
                                           VerticalOptions="Center"
                                           IsVisible="{Binding LastLocation.IsLive}" />
                                </HorizontalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Frame>
            </Grid>

            <!-- Error Message -->
            <Frame Grid.Row="3"
                  VerticalOptions="End"
                  Margin="8"
                  Padding="12"
                  CornerRadius="8"
                  BackgroundColor="#FFEBEE"
                  IsVisible="{Binding ErrorMessage, Converter={StaticResource IsNotNullConverter}}">
                <Label Text="{Binding ErrorMessage}"
                       TextColor="#C62828"
                       FontSize="14" />
            </Frame>
        </Grid>

        <!-- Loading Overlay -->
        <controls:LoadingOverlay Grid.Row="0" Grid.RowSpan="2"
                                 IsVisible="{Binding IsBusy}"
                                 Message="Loading..." />

        <!-- Date Picker Popup -->
        <picker:SfDatePicker x:Name="DatePicker"
                             Grid.RowSpan="2"
                             IsOpen="{Binding IsDatePickerOpen, Mode=TwoWay}"
                             Mode="Dialog"
                             SelectedDate="{Binding SelectedDate}"
                             MaximumDate="{x:Static sys:DateTime.Today}"
                             Format="dd_MMM_yyyy">
            <picker:SfDatePicker.HeaderView>
                <picker:PickerHeaderView Height="40" Text="Select Date" />
            </picker:SfDatePicker.HeaderView>
            <picker:SfDatePicker.FooterView>
                <picker:PickerFooterView Height="40" />
            </picker:SfDatePicker.FooterView>
        </picker:SfDatePicker>
    </Grid>
</ContentPage>
