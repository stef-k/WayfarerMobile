<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:models="clr-namespace:WayfarerMobile.Core.Models;assembly=WayfarerMobile.Core"
             xmlns:controls="clr-namespace:WayfarerMobile.Shared.Controls"
             x:Class="WayfarerMobile.Views.Controls.PublicTripsView"
             x:DataType="viewmodels:PublicTripsViewModel">

    <Grid RowDefinitions="Auto,Auto,*">

        <!-- Search Bar -->
        <SearchBar Grid.Row="0"
                   Placeholder="Search public trips..."
                   Text="{Binding SearchQuery}"
                   Margin="12,8"
                   BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />

        <!-- Sort Options -->
        <HorizontalStackLayout Grid.Row="1"
                               Margin="12,0,12,8"
                               Spacing="10">
            <Label Text="Sort by:"
                   VerticalOptions="Center"
                   FontSize="13"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
            <Picker ItemsSource="{Binding SortOptions}"
                    SelectedItem="{Binding SelectedSort}"
                    WidthRequest="140"
                    HeightRequest="36"
                    FontSize="13" />
        </HorizontalStackLayout>

        <!-- Trips List -->
        <RefreshView Grid.Row="2"
                     IsRefreshing="{Binding IsBusy}"
                     Command="{Binding RefreshCommand}">
            <CollectionView ItemsSource="{Binding Trips}"
                            RemainingItemsThreshold="5"
                            RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">

                <!-- Empty View -->
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center"
                                         HorizontalOptions="Center"
                                         Padding="30"
                                         IsVisible="{Binding IsEmpty}">
                        <Label Text="No trips found"
                               FontSize="18"
                               HorizontalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        <Label Text="Try a different search or check back later"
                               FontSize="14"
                               HorizontalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                               Margin="0,10,0,0" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <!-- Item Template -->
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:PublicTripSummary">
                        <Border Margin="12,4"
                                Padding="16"
                                StrokeThickness="0"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="12" />
                            </Border.StrokeShape>

                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="4">

                                <!-- Trip Name -->
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="{Binding Name}"
                                       FontSize="15"
                                       FontAttributes="Bold"
                                       LineBreakMode="WordWrap"
                                       MaxLines="2"
                                       TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource TextPrimaryDark}}" />

                                <!-- Clone Button -->
                                <Button Grid.Row="0" Grid.RowSpan="4" Grid.Column="1"
                                        Text="Copy"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PublicTripsViewModel}}, Path=CloneTripCommand}"
                                        CommandParameter="{Binding .}"
                                        VerticalOptions="Center"
                                        HeightRequest="36"
                                        CornerRadius="18"
                                        FontSize="12"
                                        Padding="15,0"
                                        BackgroundColor="{StaticResource Primary}"
                                        TextColor="White"
                                        IsVisible="{Binding IsOwner, Converter={StaticResource InvertedBoolConverter}}" />

                                <!-- Already Owned Badge -->
                                <Border Grid.Row="0" Grid.RowSpan="4" Grid.Column="1"
                                        Padding="12,8"
                                        StrokeThickness="0"
                                        BackgroundColor="{StaticResource Success}"
                                        VerticalOptions="Center"
                                        IsVisible="{Binding IsOwner}">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="18" />
                                    </Border.StrokeShape>
                                    <Label Text="Owned"
                                           FontSize="12"
                                           TextColor="White" />
                                </Border>

                                <!-- Description -->
                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="{Binding Description}"
                                       FontSize="13"
                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                       LineBreakMode="TailTruncation"
                                       MaxLines="2"
                                       IsVisible="{Binding Description, Converter={StaticResource IsNotNullConverter}}" />

                                <!-- Stats Row -->
                                <HorizontalStackLayout Grid.Row="2" Grid.Column="0"
                                                       Spacing="15"
                                                       Margin="0,4,0,0">
                                    <Label Text="{Binding PlacesCount, StringFormat='{0} places'}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                    <Label Text="{Binding RegionsCount, StringFormat='{0} regions'}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                                </HorizontalStackLayout>

                                <!-- Author and Date -->
                                <HorizontalStackLayout Grid.Row="3" Grid.Column="0"
                                                       Spacing="10"
                                                       Margin="0,4,0,0">
                                    <Label Text="{Binding AuthorName, StringFormat='by {0}'}"
                                           FontSize="11"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                           IsVisible="{Binding AuthorName, Converter={StaticResource IsNotNullConverter}}" />
                                    <Label Text="{Binding UpdatedAt, StringFormat='Updated {0:MMM d, yyyy}'}"
                                           FontSize="11"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" />
                                </HorizontalStackLayout>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <!-- Footer (loading more indicator) -->
                <CollectionView.Footer>
                    <ActivityIndicator IsRunning="{Binding IsLoadingMore}"
                                       IsVisible="{Binding IsLoadingMore}"
                                       Color="{StaticResource Primary}"
                                       HeightRequest="40"
                                       Margin="0,10" />
                </CollectionView.Footer>

            </CollectionView>
        </RefreshView>

        <!-- Cloning Overlay -->
        <controls:LoadingOverlay Grid.RowSpan="3"
                                 IsVisible="{Binding IsCloning}"
                                 Message="Copying trip to your account..." />

    </Grid>
</ContentView>
