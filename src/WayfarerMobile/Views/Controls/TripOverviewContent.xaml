<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:models="clr-namespace:WayfarerMobile.Core.Models;assembly=WayfarerMobile.Core"
             xmlns:sfExpander="clr-namespace:Syncfusion.Maui.Toolkit.Expander;assembly=Syncfusion.Maui.Toolkit"
             x:Class="WayfarerMobile.Views.Controls.TripOverviewContent"
             x:DataType="viewmodels:MainViewModel"
             BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

    <!-- Main content grid - no SfBottomSheet, this is placed inside MainPage's BottomSheet -->
    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Header (hidden when search is active in overview mode) -->
        <Grid Grid.Row="0" Padding="8,8,8,8" ColumnDefinitions="Auto,*,Auto,Auto"
              IsVisible="{Binding TripSheet.IsPlaceSearchVisible, Converter={StaticResource InvertedBoolConverter}}">
            <!-- Back Button (visible when showing details - goes back to overview) -->
            <Button Grid.Column="0"
                    Text="â†"
                    FontSize="18"
                    WidthRequest="36"
                    HeightRequest="36"
                    Padding="0"
                    CornerRadius="18"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource Primary}"
                    Command="{Binding TripSheet.TripSheetBackCommand}"
                    IsVisible="{Binding TripSheet.IsTripSheetShowingDetails}" />
            <!-- My Trips Button (visible when showing overview - goes to My Trips tab) -->
            <Button Grid.Column="0"
                    Text="â†"
                    FontSize="18"
                    WidthRequest="36"
                    HeightRequest="36"
                    Padding="0"
                    CornerRadius="18"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource Primary}"
                    Command="{Binding TripSheet.GoToMyTripsCommand}"
                    IsVisible="{Binding TripSheet.IsTripSheetShowingOverview}" />

            <!-- Title -->
            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                <Label Text="{Binding TripSheet.TripSheetTitle}"
                       FontSize="16"
                       FontAttributes="Bold"
                       LineBreakMode="WordWrap"
                       MaxLines="2" />
                <Label Text="{Binding TripSheet.TripSheetSubtitle}"
                       FontSize="12"
                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                       IsVisible="{Binding TripSheet.TripSheetSubtitle, Converter={StaticResource IsNotNullConverter}}" />
            </VerticalStackLayout>

            <!-- Search Toggle Button (visible in overview mode only) -->
            <Button Grid.Column="2"
                    Text="ðŸ”"
                    FontSize="16"
                    WidthRequest="36"
                    HeightRequest="36"
                    Padding="0"
                    CornerRadius="18"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource Primary}"
                    Command="{Binding TripSheet.TogglePlaceSearchCommand}"
                    IsVisible="{Binding TripSheet.IsTripSheetShowingOverview}" />

            <!-- Close Button -->
            <Button Grid.Column="3"
                    Text="âœ•"
                    FontSize="16"
                    WidthRequest="36"
                    HeightRequest="36"
                    Padding="0"
                    CornerRadius="18"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource TextSecondary}"
                    Command="{Binding TripSheet.CloseTripSheetCommand}" />
        </Grid>

        <!-- Search Bar Header (replaces header when search is active) -->
        <Grid Grid.Row="0"
              Padding="8,8,8,8"
              ColumnDefinitions="*,Auto"
              ColumnSpacing="8"
              IsVisible="{Binding TripSheet.IsPlaceSearchVisible}">
            <SearchBar Grid.Column="0"
                       Placeholder="Search places..."
                       Text="{Binding TripSheet.PlaceSearchQuery, Mode=TwoWay}"
                       FontSize="14"
                       HeightRequest="44"
                       BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}" />
            <Button Grid.Column="1"
                    Text="âœ•"
                    FontSize="16"
                    WidthRequest="36"
                    HeightRequest="36"
                    Padding="0"
                    CornerRadius="18"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource TextSecondary}"
                    Command="{Binding TripSheet.TogglePlaceSearchCommand}" />
        </Grid>

        <!-- Content Area - ScrollView for Overview/Area/Segment modes (hidden for Place and TripNotes detail views) -->
        <ScrollView Grid.Row="1"
                    IsVisible="{Binding TripSheet.IsTripSheetShowingScrollableContent}">
            <Grid>
                <!-- Overview Mode -->
                <VerticalStackLayout IsVisible="{Binding TripSheet.IsTripSheetShowingOverview}"
                                     Spacing="0">

                    <!-- Search Results (shown when searching) -->
                    <VerticalStackLayout IsVisible="{Binding TripSheet.IsPlaceSearchVisible}"
                                         Spacing="0"
                                         Padding="8">
                        <!-- No results message -->
                        <Label Text="No places found"
                               FontSize="14"
                               TextColor="{StaticResource TextSecondary}"
                               HorizontalOptions="Center"
                               Margin="0,20"
                               IsVisible="{Binding TripSheet.HasPlaceSearchResults, Converter={StaticResource InvertedBoolConverter}}" />

                        <!-- Search results list -->
                        <VerticalStackLayout BindableLayout.ItemsSource="{Binding TripSheet.PlaceSearchResults}"
                                             Spacing="1">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:TripPlace">
                                    <Border Padding="10,12" StrokeThickness="0"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8" />
                                        </Border.StrokeShape>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.SelectTripPlaceCommand}"
                                                                  CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Grid ColumnDefinitions="Auto,*" ColumnSpacing="12">
                                            <!-- Issue #185: Visibility-gated to prevent async load crashes -->
                                            <Image Grid.Column="0" WidthRequest="36" HeightRequest="36" VerticalOptions="Center">
                                                <Image.Source>
                                                    <MultiBinding Converter="{StaticResource VisibilityGatedMauiAssetImageConverter}">
                                                        <Binding Path="IconPath" />
                                                        <Binding Path="IsPageVisible" Source="{RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}" />
                                                    </MultiBinding>
                                                </Image.Source>
                                            </Image>
                                            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                                <Label Text="{Binding Name}" FontSize="15" FontAttributes="Bold"
                                                       LineBreakMode="TailTruncation" />
                                                <Label Text="{Binding Address}" FontSize="12"
                                                       TextColor="{StaticResource TextSecondary}"
                                                       LineBreakMode="TailTruncation"
                                                       IsVisible="{Binding Address, Converter={StaticResource IsNotNullConverter}}" />
                                            </VerticalStackLayout>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </VerticalStackLayout>
                    </VerticalStackLayout>

                    <!-- Normal Overview Content (hidden when searching) -->
                    <VerticalStackLayout IsVisible="{Binding TripSheet.IsPlaceSearchVisible, Converter={StaticResource InvertedBoolConverter}}"
                                         Spacing="0">

                    <!-- Trip Info Section -->
                    <VerticalStackLayout Padding="8,0,8,8" Spacing="8">
                        <!-- Cover Image (if exists) -->
                        <Border StrokeThickness="0"
                                HeightRequest="150"
                                IsVisible="{Binding TripSheet.LoadedTrip.HasCoverImage}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <!-- Use TripCoverImageUrl for visibility-aware image loading (D5 fix) -->
                            <Image Source="{Binding TripCoverImageUrl}"
                                   Aspect="AspectFill" />
                        </Border>

                        <!-- Updated At -->
                        <Label Text="{Binding TripSheet.LoadedTrip.UpdatedAt, StringFormat='Last updated: {0:MMM d, yyyy}'}"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />

                        <!-- Trip Notes (tappable to open detail view) - uses negative margin to extend to edges -->
                        <Border StrokeThickness="0"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                Margin="-8,0,-8,0"
                                Padding="16,10"
                                IsVisible="{Binding TripSheet.LoadedTrip.HasNotes}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="0" />
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding TripSheet.ShowTripNotesCommand}" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="Trip Notes"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       VerticalOptions="Center" />
                                <Label Grid.Column="1"
                                       Text="â†’"
                                       FontSize="16"
                                       TextColor="{StaticResource Primary}"
                                       VerticalOptions="Center" />
                            </Grid>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Regions with Places and Areas -->
                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding TripSheet.LoadedTrip.SortedRegions}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:TripRegion">
                                <sfExpander:SfExpander IsExpanded="True"
                                                       IsVisible="{Binding IsVisibleInUi}"
                                                       HeaderIconPosition="None">
                                    <sfExpander:SfExpander.Header>
                                        <Grid MinimumHeightRequest="40" Padding="8,6"
                                              ColumnDefinitions="Auto,Auto,*,Auto"
                                              ColumnSpacing="4"
                                              BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}">
                                            <!-- Edit Button (LEFT - tappable) -->
                                            <Border Grid.Column="0"
                                                    WidthRequest="25"
                                                    HeightRequest="25"
                                                    Margin="2,0"
                                                    StrokeThickness="0"
                                                    BackgroundColor="Transparent"
                                                    IsVisible="{Binding IsUnassignedRegion, Converter={StaticResource InvertedBoolConverter}}"
                                                    VerticalOptions="Center">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.Editor.EditRegionCommand}"
                                                                          CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Image Source="edit.png" WidthRequest="20" HeightRequest="20" VerticalOptions="Center" HorizontalOptions="Center" />
                                            </Border>
                                            <!-- Delete Button (LEFT - tappable, danger background) -->
                                            <Border Grid.Column="1"
                                                    WidthRequest="25"
                                                    HeightRequest="25"
                                                    Margin="2,0"
                                                    StrokeThickness="0"
                                                    BackgroundColor="#C62828"
                                                    IsVisible="{Binding IsUnassignedRegion, Converter={StaticResource InvertedBoolConverter}}"
                                                    VerticalOptions="Center">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="12" />
                                                </Border.StrokeShape>
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.Editor.DeleteRegionCommand}"
                                                                          CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Image Source="delete.png" WidthRequest="20" HeightRequest="20" VerticalOptions="Center" HorizontalOptions="Center" />
                                            </Border>
                                            <!-- Region Name (CENTER) -->
                                            <Label Grid.Column="2"
                                                   Text="{Binding Name}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center"
                                                   LineBreakMode="WordWrap" />
                                            <!-- Move Up/Down Buttons (RIGHT - compact with negative margins) -->
                                            <HorizontalStackLayout Grid.Column="3" Spacing="-8" VerticalOptions="Center"
                                                                   IsVisible="{Binding IsUnassignedRegion, Converter={StaticResource InvertedBoolConverter}}">
                                                <Button Text="â–²"
                                                        FontSize="10"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.Editor.MoveRegionUpCommand}"
                                                        CommandParameter="{Binding .}"
                                                        WidthRequest="28"
                                                        HeightRequest="28"
                                                        Padding="0"
                                                        BackgroundColor="Transparent"
                                                        TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                                <Button Text="â–¼"
                                                        FontSize="10"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.Editor.MoveRegionDownCommand}"
                                                        CommandParameter="{Binding .}"
                                                        WidthRequest="28"
                                                        HeightRequest="28"
                                                        Padding="0"
                                                        BackgroundColor="Transparent"
                                                        TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </sfExpander:SfExpander.Header>
                                    <sfExpander:SfExpander.Content>
                                        <VerticalStackLayout Spacing="0">
                                            <!-- Region Cover Image (shown directly if exists) -->
                                            <!-- Issue #185: Use visibility-gated binding to prevent async image load crashes -->
                                            <Border StrokeThickness="0" HeightRequest="100" Margin="8,4,8,6"
                                                    IsVisible="{Binding HasCoverImage}">
                                                <Border.StrokeShape><RoundRectangle CornerRadius="6" /></Border.StrokeShape>
                                                <Image Aspect="AspectFill">
                                                    <Image.Source>
                                                        <MultiBinding Converter="{StaticResource VisibilityGatedImageSourceConverter}">
                                                            <Binding Path="CleanCoverImageUrl" />
                                                            <Binding Path="IsPageVisible" Source="{RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}" />
                                                        </MultiBinding>
                                                    </Image.Source>
                                                </Image>
                                            </Border>
                                            <!-- Region Notes (button to show details, styled like trip notes) -->
                                            <Border StrokeThickness="0"
                                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                                    Margin="0,0,0,1"
                                                    Padding="16,10"
                                                    IsVisible="{Binding HasNotes}">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="0" />
                                                </Border.StrokeShape>
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.ShowRegionNotesCommand}"
                                                                          CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <Label Grid.Column="0"
                                                           Text="Region Notes"
                                                           FontSize="13"
                                                           FontAttributes="Bold"
                                                           VerticalOptions="Center" />
                                                    <Label Grid.Column="1"
                                                           Text="â†’"
                                                           FontSize="16"
                                                           TextColor="{StaticResource Primary}"
                                                           VerticalOptions="Center" />
                                                </Grid>
                                            </Border>
                                            <!-- Places -->
                                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Places}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="models:TripPlace">
                                                        <Border Padding="8,8" Margin="0,0,0,1" StrokeThickness="0"
                                                                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                                                            <Border.GestureRecognizers>
                                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.SelectTripPlaceCommand}"
                                                                                      CommandParameter="{Binding .}" />
                                                            </Border.GestureRecognizers>
                                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="4">
                                                                <!-- Issue #185: Visibility-gated to prevent async load crashes -->
                                                                <Image Grid.Column="0" WidthRequest="32" HeightRequest="32" VerticalOptions="Center">
                                                                    <Image.Source>
                                                                        <MultiBinding Converter="{StaticResource VisibilityGatedMauiAssetImageConverter}">
                                                                            <Binding Path="IconPath" />
                                                                            <Binding Path="IsPageVisible" Source="{RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}" />
                                                                        </MultiBinding>
                                                                    </Image.Source>
                                                                </Image>
                                                                <Label Grid.Column="1" Text="{Binding Name}" FontSize="14" VerticalOptions="Center"
                                                                       LineBreakMode="WordWrap" />
                                                                <!-- Move Up/Down Buttons (compact with negative margins) -->
                                                                <HorizontalStackLayout Grid.Column="2" Spacing="-8" VerticalOptions="Center">
                                                                    <Button Text="â–²"
                                                                            FontSize="10"
                                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.Editor.MovePlaceUpCommand}"
                                                                            CommandParameter="{Binding .}"
                                                                            WidthRequest="28"
                                                                            HeightRequest="28"
                                                                            Padding="0"
                                                                            BackgroundColor="Transparent"
                                                                            TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                                                    <Button Text="â–¼"
                                                                            FontSize="10"
                                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.Editor.MovePlaceDownCommand}"
                                                                            CommandParameter="{Binding .}"
                                                                            WidthRequest="28"
                                                                            HeightRequest="28"
                                                                            Padding="0"
                                                                            BackgroundColor="Transparent"
                                                                            TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                                                </HorizontalStackLayout>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>
                                            <!-- Areas -->
                                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Areas}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="models:TripArea">
                                                        <Border Padding="8,8" Margin="0,0,0,1" StrokeThickness="0"
                                                                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                                                            <Border.GestureRecognizers>
                                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.SelectTripAreaCommand}"
                                                                                      CommandParameter="{Binding .}" />
                                                            </Border.GestureRecognizers>
                                                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                                                <Border Grid.Column="0" WidthRequest="28" HeightRequest="28" StrokeThickness="2"
                                                                        Stroke="{Binding StrokeColor, TargetNullValue='#4CAF50'}"
                                                                        BackgroundColor="{Binding FillColor, TargetNullValue='#4CAF5040'}"
                                                                        VerticalOptions="Center">
                                                                    <Border.StrokeShape><RoundRectangle CornerRadius="4" /></Border.StrokeShape>
                                                                </Border>
                                                                <Label Grid.Column="1" Text="{Binding Name}" FontSize="14" VerticalOptions="Center"
                                                                       LineBreakMode="WordWrap" />
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>
                                    </sfExpander:SfExpander.Content>
                                </sfExpander:SfExpander>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>

                    <!-- Segments -->
                    <Label Text="Segments" FontSize="14" FontAttributes="Bold" Padding="8,10,8,6"
                           BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                           IsVisible="{Binding TripSheet.HasTripSegments}" />
                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding TripSheet.LoadedTrip.Segments}"
                                         IsVisible="{Binding TripSheet.HasTripSegments}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:TripSegment">
                                <Border Padding="8,8" Margin="0,0,0,1" StrokeThickness="0"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=TripSheet.SelectTripSegmentCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                        <Label Grid.Column="0" Text="â”â”" FontSize="14" VerticalOptions="Center" TextColor="{StaticResource Primary}" />
                                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                            <Label Text="{Binding TransportMode, StringFormat='Segment: {0}'}" FontSize="14"
                                                   LineBreakMode="WordWrap" />
                                            <HorizontalStackLayout Spacing="6">
                                                <Label Text="{Binding DistanceKm, StringFormat='{0:F1} km'}" FontSize="11"
                                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                                       IsVisible="{Binding DistanceKm, Converter={StaticResource IsNotNullConverter}}" />
                                                <Label Text="{Binding DurationMinutes, StringFormat='{0} min'}" FontSize="11"
                                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                                       IsVisible="{Binding DurationMinutes, Converter={StaticResource IsNotNullConverter}}" />
                                            </HorizontalStackLayout>
                                            <!-- From â†’ To -->
                                            <Label FontSize="11" LineBreakMode="TailTruncation"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                                   IsVisible="{Binding OriginName, Converter={StaticResource IsNotNullConverter}}">
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span Text="{Binding OriginName}" />
                                                        <Span Text=" â†’ " />
                                                        <Span Text="{Binding DestinationName}" />
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>

                    </VerticalStackLayout>
                    <!-- End Normal Overview Content -->

                </VerticalStackLayout>
                <!-- End Overview Mode -->

                <!-- Area Details Mode (hidden when showing area notes) -->
                <VerticalStackLayout IsVisible="{Binding TripSheet.IsTripSheetShowingArea}" Spacing="8" Padding="8,0,8,8">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                        <Border Grid.Column="0" WidthRequest="32" HeightRequest="32" StrokeThickness="2"
                                Stroke="{Binding TripSheet.SelectedTripArea.StrokeColor, TargetNullValue='#4CAF50'}"
                                BackgroundColor="{Binding TripSheet.SelectedTripArea.FillColor, TargetNullValue='#4CAF5040'}"
                                VerticalOptions="Start">
                            <Border.StrokeShape><RoundRectangle CornerRadius="4" /></Border.StrokeShape>
                        </Border>
                        <Label Grid.Column="1" Text="{Binding TripSheet.SelectedTripArea.Name}" FontSize="18" FontAttributes="Bold"
                               VerticalOptions="Center" LineBreakMode="WordWrap" />
                    </Grid>
                    <!-- Area Notes (tappable to open detail view) -->
                    <Border StrokeThickness="0"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                            Padding="8,10"
                            IsVisible="{Binding TripSheet.SelectedTripArea.HasNotes}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="6" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding TripSheet.ShowAreaNotesCommand}" />
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0"
                                   Text="Notes"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center" />
                            <Label Grid.Column="1"
                                   Text="â†’"
                                   FontSize="16"
                                   TextColor="{StaticResource Primary}"
                                   VerticalOptions="Center" />
                        </Grid>
                    </Border>
                </VerticalStackLayout>

                <!-- Segment Details Mode (hidden when showing segment notes) -->
                <VerticalStackLayout IsVisible="{Binding TripSheet.IsTripSheetShowingSegment}" Spacing="10" Padding="8,0,8,8">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                        <Label Grid.Column="0" Text="â”â”" FontSize="20" VerticalOptions="Start" TextColor="{StaticResource Primary}" />
                        <Label Grid.Column="1" Text="{Binding TripSheet.SelectedTripSegment.TransportMode}" FontSize="20" FontAttributes="Bold"
                               LineBreakMode="WordWrap" />
                    </Grid>
                    <HorizontalStackLayout Spacing="16">
                        <Label Text="{Binding TripSheet.SelectedTripSegment.DistanceKm, StringFormat='{0:F1} km'}" FontSize="15"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                               IsVisible="{Binding TripSheet.SelectedTripSegment.DistanceKm, Converter={StaticResource IsNotNullConverter}}" />
                        <Label Text="{Binding TripSheet.SelectedTripSegment.DurationMinutes, StringFormat='{0} minutes'}" FontSize="15"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                               IsVisible="{Binding TripSheet.SelectedTripSegment.DurationMinutes, Converter={StaticResource IsNotNullConverter}}" />
                    </HorizontalStackLayout>
                    <!-- From -->
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8"
                          IsVisible="{Binding TripSheet.SelectedTripSegment.OriginName, Converter={StaticResource IsNotNullConverter}}">
                        <Label Grid.Column="0" Text="From:" FontSize="15" FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                        <Label Grid.Column="1" Text="{Binding TripSheet.SelectedTripSegment.OriginName}" FontSize="15" LineBreakMode="WordWrap" />
                    </Grid>
                    <!-- To -->
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8"
                          IsVisible="{Binding TripSheet.SelectedTripSegment.DestinationName, Converter={StaticResource IsNotNullConverter}}">
                        <Label Grid.Column="0" Text="To:" FontSize="15" FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                        <Label Grid.Column="1" Text="{Binding TripSheet.SelectedTripSegment.DestinationName}" FontSize="15" LineBreakMode="WordWrap" />
                    </Grid>
                    <!-- Segment Notes (tappable to open detail view) -->
                    <Border StrokeThickness="0"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                            Padding="10,12"
                            IsVisible="{Binding TripSheet.SelectedTripSegment.HasNotes}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="6" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding TripSheet.ShowSegmentNotesCommand}" />
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0"
                                   Text="Notes"
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center" />
                            <Label Grid.Column="1"
                                   Text="â†’"
                                   FontSize="18"
                                   TextColor="{StaticResource Primary}"
                                   VerticalOptions="Center" />
                        </Grid>
                    </Border>
                </VerticalStackLayout>
            </Grid>
        </ScrollView>

        <!-- Place Details Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="Auto,Auto,Auto,*"
              Padding="8,0,8,8"
              RowSpacing="8"
              IsVisible="{Binding TripSheet.IsTripSheetShowingPlace}">

            <!-- Row 0: Place Header with Icon and Name -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto,*" ColumnSpacing="8">
                <!-- Issue #185: Visibility-gated to prevent async load crashes -->
                <Image Grid.Column="0" WidthRequest="36" HeightRequest="36" VerticalOptions="Start">
                    <Image.Source>
                        <MultiBinding Converter="{StaticResource VisibilityGatedMauiAssetImageConverter}">
                            <Binding Path="TripSheet.SelectedTripPlace.IconPath" />
                            <Binding Path="IsPageVisible" />
                        </MultiBinding>
                    </Image.Source>
                </Image>
                <Label Grid.Column="1" Text="{Binding TripSheet.SelectedTripPlace.Name}" FontSize="18" FontAttributes="Bold"
                       VerticalOptions="Center" LineBreakMode="WordWrap" />
            </Grid>

            <!-- Row 1: Coordinates -->
            <HorizontalStackLayout Grid.Row="1" Spacing="12">
                <HorizontalStackLayout Spacing="4">
                    <Label Text="Lat:" FontSize="14" FontAttributes="Bold" TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                    <Label Text="{Binding TripSheet.SelectedTripPlace.Latitude, StringFormat='{0:F6}'}" FontSize="14" />
                </HorizontalStackLayout>
                <HorizontalStackLayout Spacing="4">
                    <Label Text="Lon:" FontSize="14" FontAttributes="Bold" TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                    <Label Text="{Binding TripSheet.SelectedTripPlace.Longitude, StringFormat='{0:F6}'}" FontSize="14" />
                </HorizontalStackLayout>
            </HorizontalStackLayout>

            <!-- Row 2: Address (if present) -->
            <Grid Grid.Row="2" ColumnDefinitions="Auto,*" ColumnSpacing="4"
                  IsVisible="{Binding TripSheet.SelectedTripPlace.Address, Converter={StaticResource IsNotNullConverter}}">
                <Label Grid.Column="0" Text="Address:" FontSize="14" FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                <Label Grid.Column="1" Text="{Binding TripSheet.SelectedTripPlace.Address}" FontSize="14" LineBreakMode="WordWrap" />
            </Grid>

            <!-- Row 3: Notes WebView - fills remaining space, scrolls independently -->
            <Border Grid.Row="3" Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                    IsVisible="{Binding TripSheet.SelectedTripPlace.Notes, Converter={StaticResource IsNotNullConverter}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView x:Name="NotesWebView"
                         Source="{Binding TripSheet.SelectedTripPlaceNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Trip Notes Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="*"
              Padding="8,0,8,8"
              IsVisible="{Binding TripSheet.IsTripSheetShowingTripNotes}">
            <Border Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView Source="{Binding TripSheet.TripNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Area Notes Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="*"
              Padding="8,0,8,8"
              IsVisible="{Binding TripSheet.IsTripSheetShowingAreaNotes}">
            <Border Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView Source="{Binding TripSheet.SelectedTripAreaNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Segment Notes Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="*"
              Padding="8,0,8,8"
              IsVisible="{Binding TripSheet.IsTripSheetShowingSegmentNotes}">
            <Border Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView Source="{Binding TripSheet.SelectedTripSegmentNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Region Notes Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="*"
              Padding="8,0,8,8"
              IsVisible="{Binding TripSheet.IsTripSheetShowingRegionNotes}">
            <Border Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView Source="{Binding TripSheet.SelectedTripRegionNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Sticky Bottom Section -->
        <Grid Grid.Row="2"
              BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

            <!-- Overview Mode Action Buttons -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="6" Padding="8,4,8,8"
                  IsVisible="{Binding TripSheet.IsTripSheetShowingOverview}">
                <!-- Add Region/Place Button -->
                <Button Grid.Column="0"
                        Text="+ Add"
                        Command="{Binding TripSheet.Editor.AddToTripCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="8"
                        HeightRequest="44" />
                <!-- Edit Trip Button -->
                <Button Grid.Column="1"
                        Text="Edit Trip"
                        Command="{Binding TripSheet.Editor.EditLoadedTripCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="8"
                        HeightRequest="44" />
                <!-- Unload Trip Button -->
                <Button Grid.Column="2"
                        Text="Unload"
                        Command="{Binding TripSheet.Editor.ClearLoadedTripCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="8"
                        HeightRequest="44" />
            </Grid>

            <!-- Place Action Buttons (FAB style, 1 row of 6) -->
            <HorizontalStackLayout Spacing="12"
                                   Padding="8,6,8,12"
                                   HorizontalOptions="Center"
                                   IsVisible="{Binding TripSheet.IsTripSheetShowingPlace}">
                <ImageButton Source="copy.png" Command="{Binding TripSheet.Editor.CopyTripPlaceCoordsCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="share_icon.png" Command="{Binding TripSheet.Editor.ShareTripPlaceCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="edit.png" Command="{Binding TripSheet.Editor.EditTripPlaceCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="wikipedia.png" Command="{Binding TripSheet.Editor.OpenTripPlaceWikipediaCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="maps_google.png" Command="{Binding TripSheet.Editor.OpenTripPlaceInMapsCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="navigate.png" Command="{Binding TripSheet.Editor.NavigateToTripPlaceCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
            </HorizontalStackLayout>

            <!-- Area Action Buttons -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="6" Padding="8,6,8,12"
                  IsVisible="{Binding TripSheet.IsTripSheetShowingArea}">
                <Button Grid.Column="0" ImageSource="edit.png" Text=" Edit" ContentLayout="Left,4"
                        Command="{Binding TripSheet.Editor.EditAreaCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="6" HeightRequest="40" />
                <Button Grid.Column="1" ImageSource="maps_google.png" Text=" Maps" ContentLayout="Left,4"
                        Command="{Binding TripSheet.OpenTripAreaInMapsCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="6" HeightRequest="40" />
                <Button Grid.Column="2" ImageSource="wikipedia.png" Text=" Wiki" ContentLayout="Left,4"
                        Command="{Binding TripSheet.OpenTripAreaWikipediaCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="6" HeightRequest="40" />
            </Grid>

            <!-- Segment Action Buttons -->
            <Grid ColumnDefinitions="*" Padding="8,6,8,12"
                  IsVisible="{Binding TripSheet.IsTripSheetShowingSegment}">
                <Button Grid.Column="0" ImageSource="edit.png" Text=" Edit Notes" ContentLayout="Left,4"
                        Command="{Binding TripSheet.Editor.EditSegmentCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="6" HeightRequest="40" />
            </Grid>
        </Grid>
    </Grid>
</ContentView>
