<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:models="clr-namespace:WayfarerMobile.Core.Models;assembly=WayfarerMobile.Core"
             xmlns:sfExpander="clr-namespace:Syncfusion.Maui.Toolkit.Expander;assembly=Syncfusion.Maui.Toolkit"
             x:Class="WayfarerMobile.Views.Controls.TripOverviewContent"
             x:DataType="viewmodels:MainViewModel"
             BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

    <!-- Main content grid - no SfBottomSheet, this is placed inside MainPage's BottomSheet -->
    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Header -->
        <Grid Grid.Row="0" Padding="8,8,8,8" ColumnDefinitions="Auto,*,Auto">
            <!-- Back Button (visible when showing details - goes back to overview) -->
            <Button Grid.Column="0"
                    Text="←"
                    FontSize="18"
                    WidthRequest="36"
                    HeightRequest="36"
                    Padding="0"
                    CornerRadius="18"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource Primary}"
                    Command="{Binding TripSheetBackCommand}"
                    IsVisible="{Binding IsTripSheetShowingDetails}" />
            <!-- My Trips Button (visible when showing overview - goes to My Trips tab) -->
            <Button Grid.Column="0"
                    Text="← Trips"
                    FontSize="13"
                    HeightRequest="36"
                    Padding="8,0"
                    CornerRadius="18"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource Primary}"
                    Command="{Binding GoToMyTripsCommand}"
                    IsVisible="{Binding IsTripSheetShowingOverview}" />

            <!-- Title -->
            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                <Label Text="{Binding TripSheetTitle}"
                       FontSize="16"
                       FontAttributes="Bold"
                       LineBreakMode="WordWrap"
                       MaxLines="2" />
                <Label Text="{Binding TripSheetSubtitle}"
                       FontSize="12"
                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                       IsVisible="{Binding TripSheetSubtitle, Converter={StaticResource IsNotNullConverter}}" />
            </VerticalStackLayout>

            <!-- Close Button -->
            <Button Grid.Column="2"
                    Text="✕"
                    FontSize="16"
                    WidthRequest="36"
                    HeightRequest="36"
                    Padding="0"
                    CornerRadius="18"
                    BackgroundColor="Transparent"
                    TextColor="{StaticResource TextSecondary}"
                    Command="{Binding CloseTripSheetCommand}" />
        </Grid>

        <!-- Content Area - ScrollView for Overview/Area/Segment modes (hidden for Place and TripNotes detail views) -->
        <ScrollView Grid.Row="1"
                    IsVisible="{Binding IsTripSheetShowingScrollableContent}">
            <Grid>
                <!-- Overview Mode -->
                <VerticalStackLayout IsVisible="{Binding IsTripSheetShowingOverview}"
                                     Spacing="0">

                    <!-- Trip Info Section -->
                    <VerticalStackLayout Padding="8,0,8,8" Spacing="8">
                        <!-- Cover Image (if exists) -->
                        <Border StrokeThickness="0"
                                HeightRequest="150"
                                IsVisible="{Binding LoadedTrip.HasCoverImage}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="8" />
                            </Border.StrokeShape>
                            <Image Source="{Binding LoadedTrip.CoverImageUrl}"
                                   Aspect="AspectFill" />
                        </Border>

                        <!-- Updated At -->
                        <Label Text="{Binding LoadedTrip.UpdatedAt, StringFormat='Last updated: {0:MMM d, yyyy}'}"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />

                        <!-- Trip Notes (tappable to open detail view) - uses negative margin to extend to edges -->
                        <Border StrokeThickness="0"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                Margin="-8,0,-8,0"
                                Padding="16,10"
                                IsVisible="{Binding LoadedTrip.HasNotes}">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="0" />
                            </Border.StrokeShape>
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ShowTripNotesCommand}" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Grid.Column="0"
                                       Text="Trip Notes"
                                       FontSize="13"
                                       FontAttributes="Bold"
                                       VerticalOptions="Center" />
                                <Label Grid.Column="1"
                                       Text="→"
                                       FontSize="16"
                                       TextColor="{StaticResource Primary}"
                                       VerticalOptions="Center" />
                            </Grid>
                        </Border>
                    </VerticalStackLayout>

                    <!-- Regions with Places and Areas -->
                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding LoadedTrip.SortedRegions}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:TripRegion">
                                <sfExpander:SfExpander IsExpanded="True"
                                                       IsVisible="{Binding IsVisibleInUi}"
                                                       HeaderIconPosition="None">
                                    <sfExpander:SfExpander.Header>
                                        <Grid MinimumHeightRequest="40" Padding="8,6"
                                              ColumnDefinitions="Auto,Auto,*,Auto"
                                              ColumnSpacing="4"
                                              BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}">
                                            <!-- Edit Button (LEFT - tappable) -->
                                            <Border Grid.Column="0"
                                                    WidthRequest="25"
                                                    HeightRequest="25"
                                                    Margin="2,0"
                                                    StrokeThickness="0"
                                                    BackgroundColor="Transparent"
                                                    IsVisible="{Binding IsUnassignedRegion, Converter={StaticResource InvertedBoolConverter}}"
                                                    VerticalOptions="Center">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=EditRegionCommand}"
                                                                          CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Image Source="edit.png" WidthRequest="20" HeightRequest="20" VerticalOptions="Center" HorizontalOptions="Center" />
                                            </Border>
                                            <!-- Delete Button (LEFT - tappable, danger background) -->
                                            <Border Grid.Column="1"
                                                    WidthRequest="25"
                                                    HeightRequest="25"
                                                    Margin="2,0"
                                                    StrokeThickness="0"
                                                    BackgroundColor="#C62828"
                                                    IsVisible="{Binding IsUnassignedRegion, Converter={StaticResource InvertedBoolConverter}}"
                                                    VerticalOptions="Center">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="12" />
                                                </Border.StrokeShape>
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=DeleteRegionCommand}"
                                                                          CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Image Source="delete.png" WidthRequest="20" HeightRequest="20" VerticalOptions="Center" HorizontalOptions="Center" />
                                            </Border>
                                            <!-- Region Name (CENTER) -->
                                            <Label Grid.Column="2"
                                                   Text="{Binding Name}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center"
                                                   LineBreakMode="WordWrap" />
                                            <!-- Move Up/Down Buttons (RIGHT - compact with negative margins) -->
                                            <HorizontalStackLayout Grid.Column="3" Spacing="-8" VerticalOptions="Center"
                                                                   IsVisible="{Binding IsUnassignedRegion, Converter={StaticResource InvertedBoolConverter}}">
                                                <Button Text="▲"
                                                        FontSize="10"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=MoveRegionUpCommand}"
                                                        CommandParameter="{Binding .}"
                                                        WidthRequest="28"
                                                        HeightRequest="28"
                                                        Padding="0"
                                                        BackgroundColor="Transparent"
                                                        TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                                <Button Text="▼"
                                                        FontSize="10"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=MoveRegionDownCommand}"
                                                        CommandParameter="{Binding .}"
                                                        WidthRequest="28"
                                                        HeightRequest="28"
                                                        Padding="0"
                                                        BackgroundColor="Transparent"
                                                        TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                            </HorizontalStackLayout>
                                        </Grid>
                                    </sfExpander:SfExpander.Header>
                                    <sfExpander:SfExpander.Content>
                                        <VerticalStackLayout Spacing="0">
                                            <!-- Region Cover Image (shown directly if exists) -->
                                            <Border StrokeThickness="0" HeightRequest="100" Margin="8,4,8,6"
                                                    IsVisible="{Binding HasCoverImage}">
                                                <Border.StrokeShape><RoundRectangle CornerRadius="6" /></Border.StrokeShape>
                                                <Image Source="{Binding CoverImageUrl}" Aspect="AspectFill" />
                                            </Border>
                                            <!-- Region Notes (button to show details, styled like trip notes) -->
                                            <Border StrokeThickness="0"
                                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                                    Margin="0,0,0,1"
                                                    Padding="16,10"
                                                    IsVisible="{Binding HasNotes}">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="0" />
                                                </Border.StrokeShape>
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=ShowRegionNotesCommand}"
                                                                          CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Grid ColumnDefinitions="*,Auto">
                                                    <Label Grid.Column="0"
                                                           Text="Region Notes"
                                                           FontSize="13"
                                                           FontAttributes="Bold"
                                                           VerticalOptions="Center" />
                                                    <Label Grid.Column="1"
                                                           Text="→"
                                                           FontSize="16"
                                                           TextColor="{StaticResource Primary}"
                                                           VerticalOptions="Center" />
                                                </Grid>
                                            </Border>
                                            <!-- Places -->
                                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Places}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="models:TripPlace">
                                                        <Border Padding="8,8" Margin="0,0,0,1" StrokeThickness="0"
                                                                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                                                            <Border.GestureRecognizers>
                                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=SelectTripPlaceCommand}"
                                                                                      CommandParameter="{Binding .}" />
                                                            </Border.GestureRecognizers>
                                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="4">
                                                                <Image Grid.Column="0" Source="{Binding IconPath, Converter={StaticResource MauiAssetImageConverter}}"
                                                                       WidthRequest="32" HeightRequest="32" VerticalOptions="Center" />
                                                                <Label Grid.Column="1" Text="{Binding Name}" FontSize="14" VerticalOptions="Center"
                                                                       LineBreakMode="WordWrap" />
                                                                <!-- Move Up/Down Buttons (compact with negative margins) -->
                                                                <HorizontalStackLayout Grid.Column="2" Spacing="-8" VerticalOptions="Center">
                                                                    <Button Text="▲"
                                                                            FontSize="10"
                                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=MovePlaceUpCommand}"
                                                                            CommandParameter="{Binding .}"
                                                                            WidthRequest="28"
                                                                            HeightRequest="28"
                                                                            Padding="0"
                                                                            BackgroundColor="Transparent"
                                                                            TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                                                    <Button Text="▼"
                                                                            FontSize="10"
                                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=MovePlaceDownCommand}"
                                                                            CommandParameter="{Binding .}"
                                                                            WidthRequest="28"
                                                                            HeightRequest="28"
                                                                            Padding="0"
                                                                            BackgroundColor="Transparent"
                                                                            TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                                                </HorizontalStackLayout>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>
                                            <!-- Areas -->
                                            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Areas}">
                                                <BindableLayout.ItemTemplate>
                                                    <DataTemplate x:DataType="models:TripArea">
                                                        <Border Padding="8,8" Margin="0,0,0,1" StrokeThickness="0"
                                                                BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                                                            <Border.GestureRecognizers>
                                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=SelectTripAreaCommand}"
                                                                                      CommandParameter="{Binding .}" />
                                                            </Border.GestureRecognizers>
                                                            <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                                                <Border Grid.Column="0" WidthRequest="28" HeightRequest="28" StrokeThickness="2"
                                                                        Stroke="{Binding StrokeColor, TargetNullValue='#4CAF50'}"
                                                                        BackgroundColor="{Binding FillColor, TargetNullValue='#4CAF5040'}"
                                                                        VerticalOptions="Center">
                                                                    <Border.StrokeShape><RoundRectangle CornerRadius="4" /></Border.StrokeShape>
                                                                </Border>
                                                                <Label Grid.Column="1" Text="{Binding Name}" FontSize="14" VerticalOptions="Center"
                                                                       LineBreakMode="WordWrap" />
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </BindableLayout.ItemTemplate>
                                            </VerticalStackLayout>
                                        </VerticalStackLayout>
                                    </sfExpander:SfExpander.Content>
                                </sfExpander:SfExpander>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>

                    <!-- Segments -->
                    <Label Text="Segments" FontSize="14" FontAttributes="Bold" Padding="8,10,8,6"
                           BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                           IsVisible="{Binding HasTripSegments}" />
                    <VerticalStackLayout BindableLayout.ItemsSource="{Binding LoadedTrip.Segments}"
                                         IsVisible="{Binding HasTripSegments}">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate x:DataType="models:TripSegment">
                                <Border Padding="8,8" Margin="0,0,0,1" StrokeThickness="0"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=SelectTripSegmentCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                        <Label Grid.Column="0" Text="━━" FontSize="14" VerticalOptions="Center" TextColor="{StaticResource Primary}" />
                                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center" Spacing="2">
                                            <Label Text="{Binding TransportMode, StringFormat='Segment: {0}'}" FontSize="14"
                                                   LineBreakMode="WordWrap" />
                                            <HorizontalStackLayout Spacing="6">
                                                <Label Text="{Binding DistanceKm, StringFormat='{0:F1} km'}" FontSize="11"
                                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                                       IsVisible="{Binding DistanceKm, Converter={StaticResource IsNotNullConverter}}" />
                                                <Label Text="{Binding DurationMinutes, StringFormat='{0} min'}" FontSize="11"
                                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                                       IsVisible="{Binding DurationMinutes, Converter={StaticResource IsNotNullConverter}}" />
                                            </HorizontalStackLayout>
                                            <!-- From → To -->
                                            <Label FontSize="11" LineBreakMode="TailTruncation"
                                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                                   IsVisible="{Binding OriginName, Converter={StaticResource IsNotNullConverter}}">
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span Text="{Binding OriginName}" />
                                                        <Span Text=" → " />
                                                        <Span Text="{Binding DestinationName}" />
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </VerticalStackLayout>

                </VerticalStackLayout>

                <!-- Area Details Mode (hidden when showing area notes) -->
                <VerticalStackLayout IsVisible="{Binding IsTripSheetShowingArea}" Spacing="8" Padding="8,0,8,8">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                        <Border Grid.Column="0" WidthRequest="32" HeightRequest="32" StrokeThickness="2"
                                Stroke="{Binding SelectedTripArea.StrokeColor, TargetNullValue='#4CAF50'}"
                                BackgroundColor="{Binding SelectedTripArea.FillColor, TargetNullValue='#4CAF5040'}"
                                VerticalOptions="Start">
                            <Border.StrokeShape><RoundRectangle CornerRadius="4" /></Border.StrokeShape>
                        </Border>
                        <Label Grid.Column="1" Text="{Binding SelectedTripArea.Name}" FontSize="18" FontAttributes="Bold"
                               VerticalOptions="Center" LineBreakMode="WordWrap" />
                    </Grid>
                    <!-- Area Notes (tappable to open detail view) -->
                    <Border StrokeThickness="0"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                            Padding="8,10"
                            IsVisible="{Binding SelectedTripArea.HasNotes}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="6" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ShowAreaNotesCommand}" />
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0"
                                   Text="Notes"
                                   FontSize="13"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center" />
                            <Label Grid.Column="1"
                                   Text="→"
                                   FontSize="16"
                                   TextColor="{StaticResource Primary}"
                                   VerticalOptions="Center" />
                        </Grid>
                    </Border>
                </VerticalStackLayout>

                <!-- Segment Details Mode (hidden when showing segment notes) -->
                <VerticalStackLayout IsVisible="{Binding IsTripSheetShowingSegment}" Spacing="10" Padding="8,0,8,8">
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8">
                        <Label Grid.Column="0" Text="━━" FontSize="20" VerticalOptions="Start" TextColor="{StaticResource Primary}" />
                        <Label Grid.Column="1" Text="{Binding SelectedTripSegment.TransportMode}" FontSize="20" FontAttributes="Bold"
                               LineBreakMode="WordWrap" />
                    </Grid>
                    <HorizontalStackLayout Spacing="16">
                        <Label Text="{Binding SelectedTripSegment.DistanceKm, StringFormat='{0:F1} km'}" FontSize="15"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                               IsVisible="{Binding SelectedTripSegment.DistanceKm, Converter={StaticResource IsNotNullConverter}}" />
                        <Label Text="{Binding SelectedTripSegment.DurationMinutes, StringFormat='{0} minutes'}" FontSize="15"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                               IsVisible="{Binding SelectedTripSegment.DurationMinutes, Converter={StaticResource IsNotNullConverter}}" />
                    </HorizontalStackLayout>
                    <!-- From -->
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8"
                          IsVisible="{Binding SelectedTripSegment.OriginName, Converter={StaticResource IsNotNullConverter}}">
                        <Label Grid.Column="0" Text="From:" FontSize="15" FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                        <Label Grid.Column="1" Text="{Binding SelectedTripSegment.OriginName}" FontSize="15" LineBreakMode="WordWrap" />
                    </Grid>
                    <!-- To -->
                    <Grid ColumnDefinitions="Auto,*" ColumnSpacing="8"
                          IsVisible="{Binding SelectedTripSegment.DestinationName, Converter={StaticResource IsNotNullConverter}}">
                        <Label Grid.Column="0" Text="To:" FontSize="15" FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                        <Label Grid.Column="1" Text="{Binding SelectedTripSegment.DestinationName}" FontSize="15" LineBreakMode="WordWrap" />
                    </Grid>
                    <!-- Segment Notes (tappable to open detail view) -->
                    <Border StrokeThickness="0"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                            Padding="10,12"
                            IsVisible="{Binding SelectedTripSegment.HasNotes}">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="6" />
                        </Border.StrokeShape>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ShowSegmentNotesCommand}" />
                        </Border.GestureRecognizers>
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0"
                                   Text="Notes"
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center" />
                            <Label Grid.Column="1"
                                   Text="→"
                                   FontSize="18"
                                   TextColor="{StaticResource Primary}"
                                   VerticalOptions="Center" />
                        </Grid>
                    </Border>
                </VerticalStackLayout>
            </Grid>
        </ScrollView>

        <!-- Place Details Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="Auto,Auto,Auto,*"
              Padding="8,0,8,8"
              RowSpacing="8"
              IsVisible="{Binding IsTripSheetShowingPlace}">

            <!-- Row 0: Place Header with Icon and Name -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto,*" ColumnSpacing="8">
                <Image Grid.Column="0" Source="{Binding SelectedTripPlace.IconPath, Converter={StaticResource MauiAssetImageConverter}}"
                       WidthRequest="36" HeightRequest="36" VerticalOptions="Start" />
                <Label Grid.Column="1" Text="{Binding SelectedTripPlace.Name}" FontSize="18" FontAttributes="Bold"
                       VerticalOptions="Center" LineBreakMode="WordWrap" />
            </Grid>

            <!-- Row 1: Coordinates -->
            <HorizontalStackLayout Grid.Row="1" Spacing="12">
                <HorizontalStackLayout Spacing="4">
                    <Label Text="Lat:" FontSize="14" FontAttributes="Bold" TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                    <Label Text="{Binding SelectedTripPlace.Latitude, StringFormat='{0:F6}'}" FontSize="14" />
                </HorizontalStackLayout>
                <HorizontalStackLayout Spacing="4">
                    <Label Text="Lon:" FontSize="14" FontAttributes="Bold" TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                    <Label Text="{Binding SelectedTripPlace.Longitude, StringFormat='{0:F6}'}" FontSize="14" />
                </HorizontalStackLayout>
            </HorizontalStackLayout>

            <!-- Row 2: Address (if present) -->
            <Grid Grid.Row="2" ColumnDefinitions="Auto,*" ColumnSpacing="4"
                  IsVisible="{Binding SelectedTripPlace.Address, Converter={StaticResource IsNotNullConverter}}">
                <Label Grid.Column="0" Text="Address:" FontSize="14" FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                <Label Grid.Column="1" Text="{Binding SelectedTripPlace.Address}" FontSize="14" LineBreakMode="WordWrap" />
            </Grid>

            <!-- Row 3: Notes WebView - fills remaining space, scrolls independently -->
            <Border Grid.Row="3" Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}"
                    IsVisible="{Binding SelectedTripPlace.Notes, Converter={StaticResource IsNotNullConverter}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView x:Name="NotesWebView"
                         Source="{Binding SelectedTripPlaceNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Trip Notes Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="*"
              Padding="8,0,8,8"
              IsVisible="{Binding IsTripSheetShowingTripNotes}">
            <Border Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView Source="{Binding TripNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Area Notes Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="*"
              Padding="8,0,8,8"
              IsVisible="{Binding IsTripSheetShowingAreaNotes}">
            <Border Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView Source="{Binding SelectedTripAreaNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Segment Notes Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="*"
              Padding="8,0,8,8"
              IsVisible="{Binding IsTripSheetShowingSegmentNotes}">
            <Border Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView Source="{Binding SelectedTripSegmentNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Region Notes Mode - OUTSIDE ScrollView for proper WebView scrolling -->
        <Grid Grid.Row="1"
              RowDefinitions="*"
              Padding="8,0,8,8"
              IsVisible="{Binding IsTripSheetShowingRegionNotes}">
            <Border Padding="0" StrokeThickness="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray800}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="6" />
                </Border.StrokeShape>
                <WebView Source="{Binding SelectedTripRegionNotesHtml}"
                         VerticalOptions="Fill"
                         HorizontalOptions="Fill"
                         Navigating="OnNotesWebViewNavigating" />
            </Border>
        </Grid>

        <!-- Sticky Bottom Section -->
        <Grid Grid.Row="2"
              BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}">

            <!-- Overview Mode Action Buttons -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="6" Padding="8,4,8,8"
                  IsVisible="{Binding IsTripSheetShowingOverview}">
                <!-- Add Region/Place Button -->
                <Button Grid.Column="0"
                        Text="+ Add"
                        Command="{Binding AddToTripCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="8"
                        HeightRequest="44" />
                <!-- Edit Trip Button -->
                <Button Grid.Column="1"
                        Text="Edit Trip"
                        Command="{Binding EditLoadedTripCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="8"
                        HeightRequest="44" />
                <!-- Unload Trip Button -->
                <Button Grid.Column="2"
                        Text="Unload"
                        Command="{Binding ClearLoadedTripCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="8"
                        HeightRequest="44" />
            </Grid>

            <!-- Place Action Buttons (FAB style, 1 row of 6) -->
            <HorizontalStackLayout Spacing="12"
                                   Padding="8,6,8,12"
                                   HorizontalOptions="Center"
                                   IsVisible="{Binding IsTripSheetShowingPlace}">
                <ImageButton Source="copy.png" Command="{Binding CopyTripPlaceCoordsCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="share_icon.png" Command="{Binding ShareTripPlaceCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="edit.png" Command="{Binding EditTripPlaceCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="wikipedia.png" Command="{Binding OpenTripPlaceWikipediaCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="maps_google.png" Command="{Binding OpenTripPlaceInMapsCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
                <ImageButton Source="navigate.png" Command="{Binding NavigateToTripPlaceCommand}"
                             BackgroundColor="{StaticResource Gray900}"
                             WidthRequest="44" HeightRequest="44" CornerRadius="22" Padding="10" />
            </HorizontalStackLayout>

            <!-- Area Action Buttons -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="6" Padding="8,6,8,12"
                  IsVisible="{Binding IsTripSheetShowingArea}">
                <Button Grid.Column="0" ImageSource="edit.png" Text=" Edit" ContentLayout="Left,4"
                        Command="{Binding EditAreaCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="6" HeightRequest="40" />
                <Button Grid.Column="1" ImageSource="maps_google.png" Text=" Maps" ContentLayout="Left,4"
                        Command="{Binding OpenTripAreaInMapsCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="6" HeightRequest="40" />
                <Button Grid.Column="2" ImageSource="wikipedia.png" Text=" Wiki" ContentLayout="Left,4"
                        Command="{Binding OpenTripAreaWikipediaCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="6" HeightRequest="40" />
            </Grid>

            <!-- Segment Action Buttons -->
            <Grid ColumnDefinitions="*" Padding="8,6,8,12"
                  IsVisible="{Binding IsTripSheetShowingSegment}">
                <Button Grid.Column="0" ImageSource="edit.png" Text=" Edit Notes" ContentLayout="Left,4"
                        Command="{Binding EditSegmentCommand}"
                        BackgroundColor="{StaticResource Gray900}"
                        TextColor="{StaticResource White}"
                        CornerRadius="6" HeightRequest="40" />
            </Grid>
        </Grid>
    </Grid>
</ContentView>
