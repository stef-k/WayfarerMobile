<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:sfExpander="clr-namespace:Syncfusion.Maui.Toolkit.Expander;assembly=Syncfusion.Maui.Toolkit"
             x:Class="WayfarerMobile.Views.SettingsPage"
             x:DataType="vm:SettingsViewModel"
             Title="{Binding Title}">

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="10">

            <!-- Account Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Account"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="10">
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding IsLoggedIn}">
                            <Label Grid.Column="0"
                                   Text="{Binding LastSyncText, StringFormat='Last sync: {0}'}"
                                   FontSize="12"
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Button Grid.Column="1"
                                    Text="Logout"
                                    Command="{Binding LogoutCommand}"
                                    Style="{StaticResource DarkButton}"
                                    HeightRequest="36" />
                        </Grid>

                        <VerticalStackLayout IsVisible="{Binding IsLoggedIn, Converter={StaticResource InvertedBoolConverter}}"
                                             Spacing="10">
                            <Label Text="Not connected to server"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Button Text="Scan QR Code to Connect"
                                    Command="{Binding ScanQrCodeCommand}"
                                    HeightRequest="44" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Permissions & Setup Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Permissions &amp; Setup"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- Current Status -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Tracking Mode"
                                   FontSize="14"
                                   FontAttributes="Bold" />
                            <Label Text="{Binding AppearanceSettings.TrackingModeDescription}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Rerun Setup Button -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Change your permissions or tracking mode by running the setup wizard again."
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Button Text="Rerun Setup Wizard"
                                    Command="{Binding RerunSetupCommand}"
                                    Style="{StaticResource DarkButton}"
                                    HeightRequest="44" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Timeline Tracking Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Timeline Tracking"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Enable Timeline Tracking"
                                       FontSize="14" />
                                <Label Text="Log locations to server for timeline history"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding TimelineTrackingEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <VerticalStackLayout Spacing="5">
                            <Label Text="{Binding LocationTimeThreshold, StringFormat='Time threshold: {0} min'}"
                                   FontSize="14" />
                            <Label Text="Minimum time between logged locations"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Spacing="5">
                            <Label Text="{Binding LocationDistanceThreshold, StringFormat='Distance threshold: {0} m'}"
                                   FontSize="14" />
                            <Label Text="Minimum distance between logged locations"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Spacing="5">
                            <Label Text="{Binding LocationAccuracyThreshold, StringFormat='Accuracy threshold: {0} m'}"
                                   FontSize="14" />
                            <Label Text="Maximum acceptable GPS accuracy"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Navigation Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Navigation"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- Navigation Language Selection (first for prominence) -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Voice Language"
                                   FontSize="14" />
                            <Label Text="Language for turn-by-turn voice guidance"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Picker ItemsSource="{Binding NavigationSettings.LanguageOptions}"
                                    SelectedItem="{Binding NavigationSettings.SelectedLanguageOption}"
                                    Title="Select Language"
                                    HeightRequest="44" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Audio Announcements Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Audio Announcements"
                                       FontSize="14" />
                                <Label Text="Speak turn-by-turn directions"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding NavigationSettings.NavigationAudioEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <!-- Voice Volume Slider (only when audio enabled) -->
                        <VerticalStackLayout Spacing="8" IsVisible="{Binding NavigationSettings.NavigationAudioEnabled}">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Voice Volume"
                                       FontSize="14"
                                       Grid.Column="0" />
                                <Label Text="{Binding NavigationSettings.NavigationVolumePercent, StringFormat='{0}%'}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       Grid.Column="1" />
                            </Grid>
                            <Slider Minimum="0"
                                    Maximum="1"
                                    Value="{Binding NavigationSettings.NavigationVolume}" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Vibration Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Vibration"
                                       FontSize="14" />
                                <Label Text="Haptic feedback at waypoints"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding NavigationSettings.NavigationVibrationEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Auto Reroute Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Auto Reroute"
                                       FontSize="14" />
                                <Label Text="Recalculate route when off-track"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding NavigationSettings.AutoRerouteEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Distance Units -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Distance Units"
                                   FontSize="14" />
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                <Button Grid.Column="0"
                                        Text="Kilometers"
                                        Command="{Binding NavigationSettings.SetDistanceUnitsCommand}"
                                        CommandParameter="kilometers"
                                        Style="{StaticResource DarkButton}"
                                        Opacity="{Binding NavigationSettings.IsKilometers, Converter={StaticResource BoolToOpacityConverter}}"
                                        HeightRequest="36" />
                                <Button Grid.Column="1"
                                        Text="Miles"
                                        Command="{Binding NavigationSettings.SetDistanceUnitsCommand}"
                                        CommandParameter="miles"
                                        Style="{StaticResource DarkButton}"
                                        Opacity="{Binding NavigationSettings.IsMiles, Converter={StaticResource BoolToOpacityConverter}}"
                                        HeightRequest="36" />
                            </Grid>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Visit Notifications Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Visit Notifications"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- Enable Visit Notifications Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Enable Visit Notifications"
                                       FontSize="14" />
                                <Label Text="Get notified when you arrive at trip places"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                    IsToggled="{Binding VisitNotificationSettings.VisitNotificationsEnabled}"
                                    OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                 IsVisible="{Binding VisitNotificationSettings.VisitNotificationsEnabled}" />

                        <!-- Notification Style (only visible when enabled) -->
                        <VerticalStackLayout Spacing="8" IsVisible="{Binding VisitNotificationSettings.VisitNotificationsEnabled}">
                            <Label Text="Notification Style"
                                   FontSize="14" />
                            <Label Text="How to notify you about visits"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                <Button Grid.Column="0"
                                        Text="Banner"
                                        Command="{Binding VisitNotificationSettings.SetVisitNotificationStyleCommand}"
                                        CommandParameter="notification"
                                        Style="{StaticResource DarkButton}"
                                        Opacity="{Binding VisitNotificationSettings.IsVisitStyleNotification, Converter={StaticResource BoolToOpacityConverter}}"
                                        HeightRequest="36" />
                                <Button Grid.Column="1"
                                        Text="Voice"
                                        Command="{Binding VisitNotificationSettings.SetVisitNotificationStyleCommand}"
                                        CommandParameter="voice"
                                        Style="{StaticResource DarkButton}"
                                        Opacity="{Binding VisitNotificationSettings.IsVisitStyleVoice, Converter={StaticResource BoolToOpacityConverter}}"
                                        HeightRequest="36" />
                                <Button Grid.Column="2"
                                        Text="Both"
                                        Command="{Binding VisitNotificationSettings.SetVisitNotificationStyleCommand}"
                                        CommandParameter="both"
                                        Style="{StaticResource DarkButton}"
                                        Opacity="{Binding VisitNotificationSettings.IsVisitStyleBoth, Converter={StaticResource BoolToOpacityConverter}}"
                                        HeightRequest="36" />
                            </Grid>
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                 IsVisible="{Binding VisitNotificationSettings.ShowVisitVoiceOption}" />

                        <!-- Voice Announcement Toggle (only when style includes voice) -->
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding VisitNotificationSettings.ShowVisitVoiceOption}">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Voice Announcement"
                                       FontSize="14" />
                                <Label Text="Speak place name when arriving"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                    IsToggled="{Binding VisitNotificationSettings.VisitVoiceAnnouncementEnabled}"
                                    OnColor="{StaticResource Primary}" />
                        </Grid>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Offline Map Cache Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Offline Map Cache"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- Enable/Disable Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Enable Offline Cache"
                                       FontSize="14" />
                                <Label Text="Cache map tiles for offline use"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding CacheSettings.MapOfflineCacheEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Prefetch Radius Slider -->
                        <VerticalStackLayout Spacing="8">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Prefetch Radius"
                                       FontSize="14"
                                       Grid.Column="0" />
                                <Label Text="{Binding CacheSettings.PrefetchRadiusGridSize}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       Grid.Column="1" />
                            </Grid>
                            <Slider Minimum="1"
                                    Maximum="10"
                                    Value="{Binding CacheSettings.LiveCachePrefetchRadius}" />
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <Label Text="1"
                                       FontSize="10"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                       Grid.Column="0" />
                                <Label Text="{Binding CacheSettings.LiveCachePrefetchRadius}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"
                                       Grid.Column="1" />
                                <Label Text="10"
                                       FontSize="10"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                       Grid.Column="2" />
                            </Grid>
                            <Label FontSize="11"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                   Text="Controls how many map tiles are downloaded around your location. Higher values give better offline coverage but use more data and storage.&#x0a;&#x0a;• Radius 1: ~10 MB, 3×3 tiles, ~1 km coverage&#x0a;• Radius 5: ~70 MB, 11×11 tiles, ~9 km coverage&#x0a;• Radius 10: ~280 MB, 21×21 tiles, ~17 km coverage&#x0a;&#x0a;Cached tiles are reused (LRU) - moving nearby won't re-download." />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Live Cache Size -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Live Cache Size"
                                   FontSize="14" />
                            <Grid ColumnDefinitions="*,80">
                                <Slider Minimum="100"
                                        Maximum="2000"
                                        Value="{Binding CacheSettings.MaxLiveCacheSizeMB}"
                                        Grid.Column="0" />
                                <Label Text="{Binding CacheSettings.MaxLiveCacheSizeMB, StringFormat='{0} MB'}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="End"
                                       VerticalOptions="Center"
                                       Grid.Column="1" />
                            </Grid>
                            <Label Text="Maximum storage for tiles from map browsing. Old tiles are automatically removed when limit is reached."
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Trip Cache Size -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Trip Cache Size"
                                   FontSize="14" />
                            <Grid ColumnDefinitions="*,80">
                                <Slider Minimum="500"
                                        Maximum="5000"
                                        Value="{Binding CacheSettings.MaxTripCacheSizeMB}"
                                        Grid.Column="0" />
                                <Label Text="{Binding CacheSettings.MaxTripCacheSizeMB, StringFormat='{0} MB'}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="End"
                                       VerticalOptions="Center"
                                       Grid.Column="1" />
                            </Grid>
                            <Label Text="Maximum storage for downloaded trip tiles. These are preserved longer for offline trip navigation."
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Prefetch Distance -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Prefetch Distance"
                                   FontSize="14" />
                            <Grid ColumnDefinitions="*,80">
                                <Slider Minimum="100"
                                        Maximum="2000"
                                        Value="{Binding CacheSettings.PrefetchDistanceThresholdMeters}"
                                        Grid.Column="0" />
                                <Label Text="{Binding CacheSettings.PrefetchDistanceThresholdMeters, StringFormat='{0} m'}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="End"
                                       VerticalOptions="Center"
                                       Grid.Column="1" />
                            </Grid>
                            <Label Text="How far you must move before fetching new tiles. Higher values reduce data usage but may result in gaps."
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Parallel Downloads -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Parallel Downloads"
                                   FontSize="14" />
                            <Grid ColumnDefinitions="*,40">
                                <Slider Minimum="1"
                                        Maximum="4"
                                        Value="{Binding CacheSettings.MaxConcurrentTileDownloads}"
                                        Grid.Column="0" />
                                <Label Text="{Binding CacheSettings.MaxConcurrentTileDownloads}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="End"
                                       VerticalOptions="Center"
                                       Grid.Column="1" />
                            </Grid>
                            <Label Text="Number of simultaneous tile downloads. Higher values are faster but may be rate-limited by tile servers."
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Request Delay -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Request Delay"
                                   FontSize="14" />
                            <Grid ColumnDefinitions="*,80">
                                <Slider Minimum="50"
                                        Maximum="1000"
                                        Value="{Binding CacheSettings.MinTileRequestDelayMs}"
                                        Grid.Column="0" />
                                <Label Text="{Binding CacheSettings.MinTileRequestDelayMs, StringFormat='{0} ms'}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       HorizontalOptions="End"
                                       VerticalOptions="Center"
                                       Grid.Column="1" />
                            </Grid>
                            <Label Text="Minimum delay between tile requests. Higher values are more polite to tile servers but slower."
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Tile Server URL -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Tile Server URL"
                                   FontSize="14" />
                            <Entry Text="{Binding CacheSettings.TileServerUrl}"
                                   Placeholder="https://tile.openstreetmap.org/{z}/{x}/{y}.png"
                                   Keyboard="Url"
                                   FontSize="12" />
                            <Label Text="Custom tile server URL. Must contain {z}, {x}, {y} placeholders. Leave default for OpenStreetMap."
                                   FontSize="11"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Button Text="Reset to Default"
                                    Command="{Binding CacheSettings.ResetTileServerUrlCommand}"
                                    IsVisible="{Binding CacheSettings.IsDefaultTileServer, Converter={StaticResource InvertedBoolConverter}}"
                                    Style="{StaticResource DarkButton}"
                                    HeightRequest="36" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Appearance Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Appearance"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- Theme Selection -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Theme"
                                   FontSize="14" />
                            <Label Text="Choose between light, dark, or system theme"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Picker ItemsSource="{Binding AppearanceSettings.ThemeOptions}"
                                    SelectedItem="{Binding AppearanceSettings.ThemePreference}"
                                    Title="Select Theme"
                                    HeightRequest="44" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Keep Screen On Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Keep Screen On"
                                       FontSize="14" />
                                <Label Text="Prevent device from sleeping while using the app"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding AppearanceSettings.KeepScreenOn}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Battery Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Battery"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- Battery Warnings Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Battery Warnings"
                                       FontSize="14" />
                                <Label Text="Show alerts when battery is low during tracking"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding AppearanceSettings.ShowBatteryWarnings}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Auto-Pause on Critical Battery -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Auto-Pause on Critical"
                                       FontSize="14" />
                                <Label Text="Pause tracking when battery falls below 10%"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding AppearanceSettings.AutoPauseTrackingOnCriticalBattery}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Security Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Security"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- PIN Lock Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="PIN Lock"
                                       FontSize="14" />
                                <Label Text="Require PIN to access menu"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding PinSecurity.IsPinLockEnabled}"
                                        IsEnabled="{Binding PinSecurity.IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Set/Change PIN Button -->
                        <Button Text="{Binding PinSecurity.SetPinButtonText}"
                                Command="{Binding PinSecurity.SetOrChangePinCommand}"
                                IsEnabled="{Binding PinSecurity.IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                                Style="{StaticResource DarkButton}"
                                HeightRequest="44" />

                        <!-- Remove PIN Button (only when PIN configured) -->
                        <Button Text="Remove PIN Code"
                                Command="{Binding PinSecurity.RemovePinCommand}"
                                IsVisible="{Binding PinSecurity.IsPinConfigured}"
                                IsEnabled="{Binding PinSecurity.IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                                Style="{StaticResource DangerButton}"
                                HeightRequest="44" />
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Data Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Data"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <Button Text="Clear All Data"
                                Command="{Binding ClearDataCommand}"
                                Style="{StaticResource DangerButton}"
                                HeightRequest="44" />
                        <Label Text="Deletes all local data including cached trips, pending location data, and resets all settings. Your server account remains unchanged."
                               FontSize="11"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Timeline Data Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Timeline Data"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="10">
                        <Label Text="{Binding TimelineData.LocalTimelineCount, StringFormat='Local entries: {0}'}"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}" />

                        <Label Text="Export your timeline for backup or use in other applications."
                               FontSize="12"
                               Margin="0,5,0,0"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />

                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                            <Button Grid.Column="0"
                                    Text="Export CSV"
                                    Command="{Binding TimelineData.ExportCsvCommand}"
                                    Style="{StaticResource DarkButton}"
                                    HeightRequest="44" />
                            <Button Grid.Column="1"
                                    Text="Export GeoJSON"
                                    Command="{Binding TimelineData.ExportGeoJsonCommand}"
                                    Style="{StaticResource DarkButton}"
                                    HeightRequest="44" />
                        </Grid>

                        <Label Text="Import timeline data from CSV or GeoJSON files."
                               FontSize="12"
                               Margin="0,10,0,0"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />

                        <Button Text="Import Timeline"
                                Command="{Binding TimelineData.ImportTimelineCommand}"
                                Style="{StaticResource DarkButton}"
                                HeightRequest="44" />
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Diagnostics Section (simplified - single button) -->
            <Grid HeightRequest="48" Padding="10,0" ColumnDefinitions="*,Auto">
                <VerticalStackLayout Grid.Column="0" VerticalOptions="Center">
                    <Label Text="Diagnostics"
                           FontSize="16"
                           FontAttributes="Bold" />
                    <Label Text="{Binding AppVersion}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                </VerticalStackLayout>
                <Button Grid.Column="1"
                        Text="View"
                        Command="{Binding ShowDiagnosticsCommand}"
                        Style="{StaticResource DarkButton}"
                        HeightRequest="36"
                        VerticalOptions="Center" />
            </Grid>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
