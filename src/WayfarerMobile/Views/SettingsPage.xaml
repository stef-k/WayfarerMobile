<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:sfExpander="clr-namespace:Syncfusion.Maui.Toolkit.Expander;assembly=Syncfusion.Maui.Toolkit"
             x:Class="WayfarerMobile.Views.SettingsPage"
             x:DataType="vm:SettingsViewModel"
             Title="{Binding Title}">

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="10">

            <!-- Account Section -->
            <sfExpander:SfExpander IsExpanded="True">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Account"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="10">
                        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding IsLoggedIn}">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="{Binding UserEmail}"
                                       FontSize="14" />
                                <Label Text="{Binding LastSyncText, StringFormat='Last sync: {0}'}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Button Grid.Column="1"
                                    Text="Logout"
                                    Command="{Binding LogoutCommand}"
                                    Style="{StaticResource DarkButton}"
                                    HeightRequest="36" />
                        </Grid>

                        <VerticalStackLayout IsVisible="{Binding IsLoggedIn, Converter={StaticResource InvertedBoolConverter}}"
                                             Spacing="10">
                            <Label Text="Not connected to server"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Button Text="Scan QR Code to Connect"
                                    Command="{Binding ScanQrCodeCommand}"
                                    HeightRequest="44" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Permissions & Setup Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Permissions &amp; Setup"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- Current Status -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Tracking Mode"
                                   FontSize="14"
                                   FontAttributes="Bold" />
                            <Label Text="{Binding TrackingModeDescription}"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Rerun Setup Button -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Change your permissions or tracking mode by running the setup wizard again."
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            <Button Text="Rerun Setup Wizard"
                                    Command="{Binding RerunSetupCommand}"
                                    Style="{StaticResource DarkButton}"
                                    HeightRequest="44" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Timeline Tracking Section -->
            <sfExpander:SfExpander IsExpanded="True">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Timeline Tracking"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Enable Timeline Tracking"
                                       FontSize="14" />
                                <Label Text="Log locations to server for timeline history"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding TimelineTrackingEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <VerticalStackLayout Spacing="5">
                            <Label Text="{Binding LocationTimeThreshold, StringFormat='Time threshold: {0} min'}"
                                   FontSize="14" />
                            <Label Text="Minimum time between logged locations"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>

                        <VerticalStackLayout Spacing="5">
                            <Label Text="{Binding LocationDistanceThreshold, StringFormat='Distance threshold: {0} m'}"
                                   FontSize="14" />
                            <Label Text="Minimum distance between logged locations"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Navigation Section -->
            <sfExpander:SfExpander IsExpanded="True">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Navigation"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- Audio Announcements Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Audio Announcements"
                                       FontSize="14" />
                                <Label Text="Speak turn-by-turn directions"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding NavigationAudioEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Vibration Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Vibration"
                                       FontSize="14" />
                                <Label Text="Haptic feedback at waypoints"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding NavigationVibrationEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Auto Reroute Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Auto Reroute"
                                       FontSize="14" />
                                <Label Text="Recalculate route when off-track"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding AutoRerouteEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Distance Units -->
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Distance Units"
                                   FontSize="14" />
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                <Button Grid.Column="0"
                                        Text="Kilometers"
                                        Command="{Binding SetDistanceUnitsCommand}"
                                        CommandParameter="kilometers"
                                        Style="{StaticResource DarkButton}"
                                        Opacity="{Binding IsKilometers, Converter={StaticResource BoolToOpacityConverter}}"
                                        HeightRequest="36" />
                                <Button Grid.Column="1"
                                        Text="Miles"
                                        Command="{Binding SetDistanceUnitsCommand}"
                                        CommandParameter="miles"
                                        Style="{StaticResource DarkButton}"
                                        Opacity="{Binding IsMiles, Converter={StaticResource BoolToOpacityConverter}}"
                                        HeightRequest="36" />
                            </Grid>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Map Section -->
            <sfExpander:SfExpander IsExpanded="True">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Map"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Offline Map Cache"
                                       FontSize="14" />
                                <Label Text="Cache map tiles for offline use"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding MapOfflineCacheEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Appearance Section -->
            <sfExpander:SfExpander IsExpanded="True">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Appearance"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Dark Mode"
                                       FontSize="14" />
                                <Label Text="Use dark theme"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding DarkModeEnabled}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Battery Section -->
            <sfExpander:SfExpander IsExpanded="True">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Battery"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- Battery Warnings Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Battery Warnings"
                                       FontSize="14" />
                                <Label Text="Show alerts when battery is low during tracking"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding ShowBatteryWarnings}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Auto-Pause on Critical Battery -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Auto-Pause on Critical"
                                       FontSize="14" />
                                <Label Text="Pause tracking when battery falls below 10%"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding AutoPauseTrackingOnCriticalBattery}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Security Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Security"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <!-- PIN Lock Toggle -->
                        <Grid ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="PIN Lock"
                                       FontSize="14" />
                                <Label Text="Require PIN to access menu"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />
                            </VerticalStackLayout>
                            <Switch Grid.Column="1"
                                        IsToggled="{Binding PinSecurity.IsPinLockEnabled}"
                                        IsEnabled="{Binding PinSecurity.IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                                        OnColor="{StaticResource Primary}" />
                        </Grid>

                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                        <!-- Set/Change PIN Button -->
                        <Button Text="{Binding PinSecurity.SetPinButtonText}"
                                Command="{Binding PinSecurity.SetOrChangePinCommand}"
                                IsEnabled="{Binding PinSecurity.IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                                Style="{StaticResource DarkButton}"
                                HeightRequest="44" />

                        <!-- Remove PIN Button (only when PIN configured) -->
                        <Button Text="Remove PIN Code"
                                Command="{Binding PinSecurity.RemovePinCommand}"
                                IsVisible="{Binding PinSecurity.IsPinConfigured}"
                                IsEnabled="{Binding PinSecurity.IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                                Style="{StaticResource DangerButton}"
                                HeightRequest="44" />
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Data Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Data"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="15">
                        <Button Text="Clear All Data"
                                Command="{Binding ClearDataCommand}"
                                Style="{StaticResource DangerButton}"
                                HeightRequest="44" />
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

            <!-- Diagnostics Section -->
            <sfExpander:SfExpander IsExpanded="False">
                <sfExpander:SfExpander.Header>
                    <Grid HeightRequest="48" Padding="10,0">
                        <Label Text="Diagnostics"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center" />
                    </Grid>
                </sfExpander:SfExpander.Header>
                <sfExpander:SfExpander.Content>
                    <VerticalStackLayout Padding="15" Spacing="10">
                        <Label Text="{Binding AppVersion}"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}" />

                        <Button Text="View Diagnostics"
                                Command="{Binding ShowDiagnosticsCommand}"
                                Style="{StaticResource DarkButton}"
                                HeightRequest="44" />
                    </VerticalStackLayout>
                </sfExpander:SfExpander.Content>
            </sfExpander:SfExpander>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
