<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:controls="clr-namespace:WayfarerMobile.Views.Controls"
             xmlns:sharedControls="clr-namespace:WayfarerMobile.Shared.Controls"
             xmlns:offlineBanner="clr-namespace:WayfarerMobile.Views.Controls"
             xmlns:tabView="clr-namespace:Syncfusion.Maui.Toolkit.TabView;assembly=Syncfusion.Maui.Toolkit"
             x:Class="WayfarerMobile.Views.TripsPage"
             x:DataType="viewmodels:TripsViewModel"
             Title="Trips"
             BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}">

    <Grid RowDefinitions="Auto,*">
        <!-- Offline Banner -->
        <offlineBanner:OfflineBanner Grid.Row="0" />

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <!-- Not Configured Message -->
            <VerticalStackLayout IsVisible="{Binding IsConfigured, Converter={StaticResource InvertedBoolConverter}}"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="16"
                                 Padding="24">
                <Label Text="Not Configured"
                       FontSize="24"
                       FontAttributes="Bold"
                       HorizontalTextAlignment="Center" />
                <Label Text="Please configure your server URL and API token in Settings to view your trips."
                       FontSize="14"
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                <Button Text="Go to Settings"
                        Command="{Binding GoToSettingsCommand}"
                        HorizontalOptions="Center"
                        Margin="0,10,0,0" />
            </VerticalStackLayout>

            <!-- Tab View (when configured) -->
            <tabView:SfTabView x:Name="TabView"
                               IsVisible="{Binding IsConfigured}"
                               TabBarBackground="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                               TabBarPlacement="Top"
                               IndicatorBackground="{StaticResource Primary}"
                               TabWidthMode="SizeToContent"
                               SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}">

                <!-- Tab Item Style with Visual State Manager for proper theme support -->
                <tabView:SfTabView.Resources>
                    <Style TargetType="tabView:SfTabItem">
                        <Setter Property="VisualStateManager.VisualStateGroups">
                            <VisualStateGroupList>
                                <VisualStateGroup x:Name="CommonStates">
                                    <VisualState x:Name="Normal">
                                        <VisualState.Setters>
                                            <Setter Property="TextColor" Value="{AppThemeBinding Light=#757575, Dark=#B0B0B0}" />
                                            <Setter Property="FontSize" Value="14" />
                                        </VisualState.Setters>
                                    </VisualState>
                                    <VisualState x:Name="Selected">
                                        <VisualState.Setters>
                                            <Setter Property="TextColor" Value="{AppThemeBinding Light=#212121, Dark=#FFFFFF}" />
                                            <Setter Property="FontSize" Value="14" />
                                            <Setter Property="FontAttributes" Value="Bold" />
                                        </VisualState.Setters>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateGroupList>
                        </Setter>
                    </Style>
                </tabView:SfTabView.Resources>

                <!-- My Trips Tab -->
                <tabView:SfTabItem Header="My Trips">
                    <tabView:SfTabItem.Content>
                        <controls:MyTripsView BindingContext="{Binding}" />
                    </tabView:SfTabItem.Content>
                </tabView:SfTabItem>

                <!-- Public Trips Tab -->
                <tabView:SfTabItem Header="Public Trips">
                    <tabView:SfTabItem.Content>
                        <controls:PublicTripsView BindingContext="{Binding}" />
                    </tabView:SfTabItem.Content>
                </tabView:SfTabItem>

            </tabView:SfTabView>

            <!-- Download Progress Overlay -->
            <Border IsVisible="{Binding IsDownloading}"
                    VerticalOptions="End"
                    Margin="16"
                    Padding="16"
                    BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                    StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="8">
                    <Label Grid.Row="0" Grid.Column="0"
                           Text="{Binding DownloadingTripName, StringFormat='Downloading: {0}'}"
                           FontSize="14"
                           FontAttributes="Bold"
                           LineBreakMode="TailTruncation" />
                    <Button Grid.Row="0" Grid.Column="1"
                            Text="Cancel"
                            Command="{Binding CancelDownloadCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Error}"
                            FontSize="12"
                            Padding="8,0" />
                    <ProgressBar Grid.Row="1" Grid.ColumnSpan="2"
                                 Progress="{Binding DownloadProgress}"
                                 ProgressColor="{StaticResource Primary}"
                                 HeightRequest="6" />
                    <Label Grid.Row="2" Grid.ColumnSpan="2"
                           Text="{Binding DownloadStatusMessage}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                </Grid>
            </Border>

            <!-- Error Message -->
            <Border VerticalOptions="End"
                    Margin="16,0,16,80"
                    Padding="12"
                    BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#4A1414}"
                    StrokeThickness="0"
                    IsVisible="{Binding ErrorMessage, Converter={StaticResource IsNotNullConverter}}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="8" />
                </Border.StrokeShape>
                <Grid ColumnDefinitions="*,Auto">
                    <Label Text="{Binding ErrorMessage}"
                           TextColor="{AppThemeBinding Light=#C62828, Dark=#FF8A80}"
                           FontSize="14" />
                    <Button Grid.Column="1"
                            Text="Ã—"
                            Command="{Binding DismissErrorCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light=#C62828, Dark=#FF8A80}"
                            FontSize="18"
                            WidthRequest="32"
                            HeightRequest="32"
                            Padding="0" />
                </Grid>
            </Border>
        </Grid>
    </Grid>
</ContentPage>
