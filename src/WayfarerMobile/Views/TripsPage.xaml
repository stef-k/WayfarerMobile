<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:WayfarerMobile.ViewModels"
             xmlns:models="clr-namespace:WayfarerMobile.Core.Models"
             xmlns:mapsui="clr-namespace:Mapsui.UI.Maui;assembly=Mapsui.UI.Maui"
             xmlns:navDrawer="clr-namespace:Syncfusion.Maui.Toolkit.NavigationDrawer;assembly=Syncfusion.Maui.Toolkit"
             xmlns:controls="clr-namespace:WayfarerMobile.Shared.Controls"
             x:Class="WayfarerMobile.Views.TripsPage"
             x:DataType="viewmodels:TripsViewModel"
             Title="Trips"
             BackgroundColor="{StaticResource Background}">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Public"
                     Command="{Binding BrowsePublicTripsCommand}"
                     Order="Primary" />
    </ContentPage.ToolbarItems>

    <Grid>
        <!-- Not Configured Message -->
        <VerticalStackLayout IsVisible="{Binding IsConfigured, Converter={StaticResource InvertedBoolConverter}}"
                            VerticalOptions="Center"
                            HorizontalOptions="Center"
                            Spacing="16"
                            Padding="24">
            <Label Text="Not Configured"
                   FontSize="24"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center" />
            <Label Text="Please configure your server URL and API token in Settings to view your trips."
                   FontSize="14"
                   HorizontalTextAlignment="Center"
                   TextColor="{StaticResource Gray500}" />
        </VerticalStackLayout>

        <!-- Main Content (when configured) -->
        <Grid IsVisible="{Binding IsConfigured}">

            <!-- Trip List View -->
            <Grid IsVisible="{Binding ShowingList}" RowDefinitions="*">
                <RefreshView Command="{Binding LoadTripsCommand}"
                            IsRefreshing="{Binding IsLoadingTrips}">
                    <CollectionView ItemsSource="{Binding AvailableTrips}"
                                   SelectionMode="None">

                        <!-- Empty State -->
                        <CollectionView.EmptyView>
                            <VerticalStackLayout VerticalOptions="Center"
                                                HorizontalOptions="Center"
                                                Spacing="16"
                                                Padding="32">
                                <Label Text="ðŸ—ºï¸"
                                       FontSize="64"
                                       HorizontalOptions="Center" />
                                <Label Text="No trips found"
                                       Style="{StaticResource Headline}"
                                       HorizontalOptions="Center" />
                                <Label Text="Create trips on the web app or browse public trips."
                                       Style="{StaticResource Body}"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center"
                                       TextColor="{StaticResource TextSecondary}" />
                                <Button Text="Browse Public Trips"
                                        Command="{Binding BrowsePublicTripsCommand}"
                                        HorizontalOptions="Center"
                                        Margin="0,10,0,0"
                                        HeightRequest="44"
                                        CornerRadius="22" />
                            </VerticalStackLayout>
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:TripSummary">
                                <Border Margin="8,4"
                                        Padding="16"
                                        StrokeThickness="0"
                                        BackgroundColor="{StaticResource Surface}">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TripsViewModel}}, Path=SelectTripCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>

                                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto">
                                        <!-- Trip Name -->
                                        <Label Grid.Row="0"
                                               Text="{Binding Name}"
                                               Style="{StaticResource SubHeadline}"
                                               FontAttributes="Bold"
                                               LineBreakMode="TailTruncation" />

                                        <!-- Public Badge -->
                                        <Border Grid.Row="0" Grid.Column="1"
                                                BackgroundColor="{StaticResource Primary}"
                                                Padding="8,2"
                                                StrokeThickness="0"
                                                IsVisible="{Binding IsPublic}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="8" />
                                            </Border.StrokeShape>
                                            <Label Text="Public"
                                                   FontSize="10"
                                                   TextColor="White" />
                                        </Border>

                                        <!-- Location Info -->
                                        <Label Grid.Row="1" Grid.ColumnSpan="2"
                                               Text="{Binding LocationsText}"
                                               Style="{StaticResource Caption}"
                                               TextColor="{StaticResource TextSecondary}"
                                               Margin="0,4,0,0" />

                                        <!-- Last Updated -->
                                        <Label Grid.Row="2" Grid.ColumnSpan="2"
                                               Text="{Binding UpdatedAt, StringFormat='Updated {0:MMM d, yyyy}'}"
                                               Style="{StaticResource Caption}"
                                               TextColor="{StaticResource Gray400}"
                                               Margin="0,4,0,0" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </RefreshView>
            </Grid>

            <!-- Trip Details View with Navigation Drawer -->
            <navDrawer:SfNavigationDrawer x:Name="navigationDrawer"
                                          IsVisible="{Binding ShowingDetails}"
                                          IsOpen="{Binding IsSidebarOpen, Mode=TwoWay}">

                <!-- Drawer Settings -->
                <navDrawer:SfNavigationDrawer.DrawerSettings>
                    <navDrawer:DrawerSettings Position="Right"
                                              DrawerWidth="300"
                                              DrawerHeaderHeight="60"
                                              DrawerFooterHeight="0"
                                              EnableSwipeGesture="True"
                                              Transition="SlideOnTop">

                        <!-- Drawer Header -->
                        <navDrawer:DrawerSettings.DrawerHeaderView>
                            <Grid BackgroundColor="{StaticResource Surface}"
                                  Padding="16,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Label Text="Places"
                                       Style="{StaticResource SubHeadline}"
                                       FontAttributes="Bold"
                                       VerticalOptions="Center" />
                                <Button Grid.Column="1"
                                        Text="X"
                                        FontSize="16"
                                        WidthRequest="36"
                                        HeightRequest="36"
                                        Padding="0"
                                        CornerRadius="18"
                                        BackgroundColor="Transparent"
                                        TextColor="{StaticResource TextSecondary}"
                                        Command="{Binding CloseSidebarCommand}" />
                            </Grid>
                        </navDrawer:DrawerSettings.DrawerHeaderView>

                        <!-- Drawer Content - Places List -->
                        <navDrawer:DrawerSettings.DrawerContentView>
                            <Grid BackgroundColor="{StaticResource Background}">
                                <CollectionView ItemsSource="{Binding SelectedTripDetails.AllPlaces}"
                                               SelectionMode="None">

                                    <CollectionView.EmptyView>
                                        <Label Text="No places in this trip"
                                               Style="{StaticResource Caption}"
                                               TextColor="{StaticResource TextSecondary}"
                                               HorizontalOptions="Center"
                                               Margin="16" />
                                    </CollectionView.EmptyView>

                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:TripPlace">
                                            <Border Margin="8,2"
                                                    Padding="12"
                                                    StrokeThickness="0"
                                                    BackgroundColor="{StaticResource Surface}">
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TripsViewModel}}, Path=SelectPlaceCommand}"
                                                                          CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                                    <!-- Color Indicator -->
                                                    <Ellipse WidthRequest="12"
                                                             HeightRequest="12"
                                                             Fill="{Binding MarkerColor}"
                                                             VerticalOptions="Center" />

                                                    <!-- Place Name -->
                                                    <Label Grid.Column="1"
                                                           Text="{Binding Name}"
                                                           Style="{StaticResource Body}"
                                                           VerticalOptions="Center"
                                                           LineBreakMode="TailTruncation" />

                                                    <!-- Navigate Button -->
                                                    <Button Grid.Column="2"
                                                            Text=">"
                                                            FontSize="12"
                                                            WidthRequest="32"
                                                            HeightRequest="32"
                                                            Padding="0"
                                                            CornerRadius="16"
                                                            BackgroundColor="{StaticResource Primary}"
                                                            TextColor="White"
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:TripsViewModel}}, Path=NavigateToPlaceCommand}"
                                                            CommandParameter="{Binding .}" />
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </navDrawer:DrawerSettings.DrawerContentView>

                    </navDrawer:DrawerSettings>
                </navDrawer:SfNavigationDrawer.DrawerSettings>

                <!-- Main Content View -->
                <navDrawer:SfNavigationDrawer.ContentView>
                    <Grid RowDefinitions="Auto,Auto,*">
                        <!-- Header with Back Button and Actions -->
                        <Grid Grid.Row="0"
                              ColumnDefinitions="Auto,*,Auto,Auto"
                              BackgroundColor="{StaticResource Surface}"
                              Padding="8">
                            <Button Text="&lt;"
                                    Command="{Binding BackToListCommand}"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource Primary}"
                                    FontSize="18"
                                    WidthRequest="44"
                                    HeightRequest="44" />
                            <Label Grid.Column="1"
                                   Text="{Binding SelectedTrip.Name}"
                                   Style="{StaticResource SubHeadline}"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Start"
                                   LineBreakMode="TailTruncation"
                                   Margin="8,0" />

                            <!-- Download Button (when not downloaded) -->
                            <Button Grid.Column="2"
                                    Text="Download"
                                    Command="{Binding DownloadTripCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    FontSize="12"
                                    Padding="12,4"
                                    CornerRadius="4"
                                    IsVisible="{Binding IsSelectedTripDownloaded, Converter={StaticResource InvertedBoolConverter}}"
                                    IsEnabled="{Binding IsDownloading, Converter={StaticResource InvertedBoolConverter}}" />

                            <!-- Offline Badge (when downloaded) -->
                            <Button Grid.Column="2"
                                    Text="Offline"
                                    Command="{Binding DeleteDownloadedTripCommand}"
                                    BackgroundColor="{StaticResource Success}"
                                    TextColor="White"
                                    FontSize="12"
                                    Padding="12,4"
                                    CornerRadius="4"
                                    IsVisible="{Binding IsSelectedTripDownloaded}" />

                            <!-- Places Sidebar Toggle -->
                            <Button Grid.Column="3"
                                    Text="="
                                    Command="{Binding ToggleSidebarCommand}"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource Primary}"
                                    FontSize="18"
                                    WidthRequest="44"
                                    HeightRequest="44" />
                        </Grid>

                        <!-- Download Progress -->
                        <Grid Grid.Row="1"
                              BackgroundColor="{StaticResource Surface}"
                              Padding="16,8"
                              IsVisible="{Binding IsDownloading}">
                            <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto">
                                <ProgressBar Progress="{Binding DownloadProgress, Converter={StaticResource PercentToDecimalConverter}}"
                                            ProgressColor="{StaticResource Primary}"
                                            HeightRequest="4" />
                                <Label Grid.Column="1"
                                       Text="{Binding DownloadProgress, StringFormat='{0}%'}"
                                       FontSize="12"
                                       TextColor="{StaticResource TextSecondary}"
                                       Margin="8,0,0,0" />
                                <Label Grid.Row="1" Grid.ColumnSpan="2"
                                       Text="{Binding DownloadStatusMessage}"
                                       FontSize="12"
                                       TextColor="{StaticResource TextSecondary}"
                                       Margin="0,4,0,0" />
                            </Grid>
                        </Grid>

                        <!-- Full Map View -->
                        <Grid Grid.Row="2">
                            <mapsui:MapControl Map="{Binding Map}" />

                            <!-- Loading overlay -->
                            <controls:LoadingOverlay IsVisible="{Binding IsLoadingDetails}"
                                                     Message="Loading trip..." />

                            <!-- Navigation Info Overlay -->
                            <Border IsVisible="{Binding IsNavigating}"
                                    VerticalOptions="End"
                                    HorizontalOptions="Fill"
                                    Margin="16,0,16,16"
                                    Padding="16"
                                    BackgroundColor="{StaticResource Surface}"
                                    StrokeThickness="0">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                                    <Label Text="{Binding NavigationDestination, StringFormat='Navigating to {0}'}"
                                           Style="{StaticResource Body}"
                                           FontAttributes="Bold" />
                                    <Label Grid.Row="1"
                                           Text="{Binding NavigationState.DistanceText}"
                                           Style="{StaticResource Caption}"
                                           TextColor="{StaticResource TextSecondary}" />
                                    <Button Grid.Column="1" Grid.RowSpan="2"
                                            Text="Stop"
                                            Command="{Binding StopNavigationCommand}"
                                            BackgroundColor="{StaticResource Error}"
                                            TextColor="White"
                                            FontSize="12"
                                            Padding="16,8"
                                            CornerRadius="4"
                                            VerticalOptions="Center" />
                                </Grid>
                            </Border>

                            <!-- Floating Action Button to Open Sidebar (when closed) -->
                            <Button IsVisible="{Binding IsSidebarOpen, Converter={StaticResource InvertedBoolConverter}}"
                                    Text="Places"
                                    Command="{Binding OpenSidebarCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    FontSize="12"
                                    Padding="16,8"
                                    CornerRadius="20"
                                    VerticalOptions="Start"
                                    HorizontalOptions="End"
                                    Margin="0,16,16,0" />
                        </Grid>
                    </Grid>
                </navDrawer:SfNavigationDrawer.ContentView>

            </navDrawer:SfNavigationDrawer>
        </Grid>

        <!-- Error Message -->
        <Border VerticalOptions="End"
                Margin="8"
                Padding="12"
                BackgroundColor="#FFEBEE"
                StrokeThickness="0"
                IsVisible="{Binding ErrorMessage, Converter={StaticResource IsNotNullConverter}}">
            <Label Text="{Binding ErrorMessage}"
                   TextColor="#C62828"
                   FontSize="14" />
        </Border>
    </Grid>
</ContentPage>
