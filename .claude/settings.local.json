{
  "permissions": {
    "allow": [
      "Bash(dotnet build:*)",
      "WebSearch",
      "WebFetch(domain:openrouteservice.org)",
      "Bash(git add:*)",
      "Bash(git commit -m \"$(cat <<''EOF''\nfeat: add OSRM routing, route caching, and lock screen overlay\n\n- Add OsrmRoutingService for online route calculation via OSRM API\n- Add RouteCacheService for session-based route caching with validation\n- Implement lock screen overlay with PIN entry on app resume\n- Update TripNavigationService with route calculation priority system\n- Update navigation documentation with architecture details\nEOF\n)\")",
      "WebFetch(domain:help.syncfusion.com)",
      "Bash(cat:*)",
      "Bash(powershell -Command:*)",
      "Bash(git checkout:*)",
      "Bash(git commit:*)",
      "WebFetch(domain:github.com)",
      "Bash(find:*)",
      "Bash(dir:*)",
      "Bash(findstr:*)",
      "Bash(dotnet restore:*)",
      "Bash(dotnet test:*)",
      "Bash(dotnet sln:*)",
      "Bash(grep:*)",
      "Bash(cmd /c \"type nul > \"\"C:\\Users\\stef\\source\\repos\\WayfarerMobile\\tests\\WayfarerMobile.Tests\\Unit\\Models\\GroupLocationModelsTests.cs\"\"\")",
      "Bash(cmd /c:*)",
      "Bash(printf:*)",
      "Bash(echo:*)",
      "Bash(# Create the TestSseClient content in a file first\ncontent=$(cat << ''ENDCONTENT''\n\n/// <summary>\n/// Test implementation of SseClient for unit testing.\n/// </summary>\ninternal sealed class TestSseClient : ISseClient\n{\n    private readonly ISettingsService _settings;\n    private readonly ILogger<TestSseClient> _logger;\n    private readonly IHttpClientFactory _httpClientFactory;\n    private CancellationTokenSource? _cancellationTokenSource;\n    private readonly object _connectionLock = new();\n    private bool _disposed;\n    private volatile bool _isConnected;\n\n    private static readonly JsonSerializerOptions JsonOptions = new() { PropertyNameCaseInsensitive = true };\n    private static readonly int[] BackoffDelaysMs = [1000, 2000, 5000];\n\n    public event EventHandler<SseLocationEventArgs>? LocationReceived;\n    public event EventHandler<SseMembershipEventArgs>? MembershipReceived;\n    public event EventHandler? HeartbeatReceived;\n    public event EventHandler? Connected;\n    public event EventHandler<SseReconnectEventArgs>? Reconnecting;\n\n    public bool IsConnected => _isConnected;\n\n    public TestSseClient(ISettingsService settings, ILogger<TestSseClient> logger, IHttpClientFactory httpClientFactory)\n    {\n        _settings = settings ?? throw new ArgumentNullException(nameof(settings));\n        _logger = logger ?? throw new ArgumentNullException(nameof(logger));\n        _httpClientFactory = httpClientFactory ?? throw new ArgumentNullException(nameof(httpClientFactory));\n    }\n\n    public async Task SubscribeToUserAsync(string userName, CancellationToken cancellationToken = default)\n    {\n        if (string.IsNullOrWhiteSpace(userName)) { _logger.LogWarning(\"\"userName is empty\"\"); return; }\n        var serverUrl = _settings.ServerUrl;\n        if (string.IsNullOrWhiteSpace(serverUrl)) { _logger.LogError(\"\"Server URL not configured\"\"); return; }\n        var url = serverUrl.TrimEnd(char.Parse(\"\"/\"\")) + \"\"/api/mobile/sse/location-update/\"\" + Uri.EscapeDataString(userName);\n        await SubscribeAsync(url, \"\"user:\"\" + userName, cancellationToken).ConfigureAwait(false);\n    }\n\n    public async Task SubscribeToGroupAsync(string groupId, CancellationToken cancellationToken = default)\n    {\n        if (string.IsNullOrWhiteSpace(groupId)) { _logger.LogWarning(\"\"groupId is empty\"\"); return; }\n        var serverUrl = _settings.ServerUrl;\n        if (string.IsNullOrWhiteSpace(serverUrl)) { _logger.LogError(\"\"Server URL not configured\"\"); return; }\n        var url = serverUrl.TrimEnd(char.Parse(\"\"/\"\")) + \"\"/api/mobile/sse/group-location-update/\"\" + Uri.EscapeDataString(groupId);\n        await SubscribeAsync(url, \"\"group:\"\" + groupId, cancellationToken).ConfigureAwait(false);\n    }\n\n    public async Task SubscribeToGroupMembershipAsync(string groupId, CancellationToken cancellationToken = default)\n    {\n        if (string.IsNullOrWhiteSpace(groupId)) { _logger.LogWarning(\"\"groupId is empty\"\"); return; }\n        var serverUrl = _settings.ServerUrl;\n        if (string.IsNullOrWhiteSpace(serverUrl)) { _logger.LogError(\"\"Server URL not configured\"\"); return; }\n        var url = serverUrl.TrimEnd(char.Parse(\"\"/\"\")) + \"\"/api/sse/stream/group-membership-update/\"\" + Uri.EscapeDataString(groupId);\n        await SubscribeAsync(url, \"\"group-membership:\"\" + groupId, cancellationToken).ConfigureAwait(false);\n    }\n\n    public void Stop()\n    {\n        lock (_connectionLock) { _cancellationTokenSource?.Cancel(); _isConnected = false; }\n        _logger.LogInformation(\"\"SSE subscription stopped\"\");\n    }\n\n    private async Task SubscribeAsync(string url, string channelName, CancellationToken externalToken)\n    {\n        Stop();\n        CancellationTokenSource cts;\n        lock (_connectionLock) { _cancellationTokenSource = CancellationTokenSource.CreateLinkedTokenSource(externalToken); cts = _cancellationTokenSource; }\n        var cancellationToken = cts.Token;\n        int reconnectAttempt = 0;\n\n        while (!cancellationToken.IsCancellationRequested)\n        {\n            try\n            {\n                if (reconnectAttempt > 0)\n                {\n                    int delayMs = BackoffDelaysMs[Math.Min(reconnectAttempt - 1, BackoffDelaysMs.Length - 1)];\n                    Reconnecting?.Invoke(this, new SseReconnectEventArgs(reconnectAttempt, delayMs));\n                    await Task.Delay(delayMs, cancellationToken).ConfigureAwait(false);\n                }\n                await ConnectAndStreamAsync(url, cancellationToken).ConfigureAwait(false);\n                break;\n            }\n            catch (OperationCanceledException) { break; }\n            catch (Exception ex) when (IsCancellationException(ex)) { break; }\n            catch (Exception) { reconnectAttempt++; _isConnected = false; }\n        }\n        _isConnected = false;\n    }\n\n    private async Task ConnectAndStreamAsync(string url, CancellationToken cancellationToken)\n    {\n        var apiToken = _settings.ApiToken;\n        if (string.IsNullOrWhiteSpace(apiToken)) { _logger.LogError(\"\"API token not configured\"\"); return; }\n        cancellationToken.ThrowIfCancellationRequested();\n\n        var httpClient = _httpClientFactory.CreateClient();\n        httpClient.Timeout = TimeSpan.FromMinutes(30);\n\n        using var request = new HttpRequestMessage(HttpMethod.Get, url);\n        request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue(\"\"Bearer\"\", apiToken);\n        request.Headers.Accept.Add(new System.Net.Http.Headers.MediaTypeWithQualityHeaderValue(\"\"text/event-stream\"\"));\n\n        HttpResponseMessage? response;\n        try { response = await httpClient.SendAsync(request, HttpCompletionOption.ResponseHeadersRead, cancellationToken).ConfigureAwait(false); }\n        catch (OperationCanceledException) { throw; }\n        catch (Exception ex) when (IsCancellationException(ex)) { throw new OperationCanceledException(\"\"SSE connection was cancelled\"\", ex); }\n\n        using (response)\n        {\n            if (!response.IsSuccessStatusCode) { throw new HttpRequestException(\"\"SSE subscription failed: \"\" + response.StatusCode); }\n            _isConnected = true;\n            Connected?.Invoke(this, EventArgs.Empty);\n            await using var stream = await response.Content.ReadAsStreamAsync(cancellationToken).ConfigureAwait(false);\n            using var reader = new StreamReader(stream, Encoding.UTF8);\n            await ParseSseStreamAsync(reader, cancellationToken).ConfigureAwait(false);\n        }\n    }\n\n    private async Task ParseSseStreamAsync(StreamReader reader, CancellationToken cancellationToken)\n    {\n        var dataBuffer = new StringBuilder();\n        while (!cancellationToken.IsCancellationRequested)\n        {\n            string? line;\n            try { line = await reader.ReadLineAsync(cancellationToken).ConfigureAwait(false); }\n            catch (OperationCanceledException) { return; }\n            catch (Exception ex) when (IsCancellationException(ex)) { return; }\n            if (line == null) break;\n            if (line.StartsWith(char.Parse(\"\":\"\"))) { HeartbeatReceived?.Invoke(this, EventArgs.Empty); continue; }\n            if (line.StartsWith(\"\"data:\"\", StringComparison.OrdinalIgnoreCase)) { dataBuffer.Append(line[5..].TrimStart()); continue; }\n            if (string.IsNullOrWhiteSpace(line) && dataBuffer.Length > 0) { ProcessEventData(dataBuffer.ToString()); dataBuffer.Clear(); }\n        }\n    }\n\n    private void ProcessEventData(string json)\n    {\n        try\n        {\n            var locationEvent = JsonSerializer.Deserialize<SseLocationEvent>(json, JsonOptions);\n            if (locationEvent != null && !string.IsNullOrEmpty(locationEvent.UserName)) { LocationReceived?.Invoke(this, new SseLocationEventArgs(locationEvent)); return; }\n            var membershipEvent = JsonSerializer.Deserialize<SseMembershipEvent>(json, JsonOptions);\n            if (membershipEvent != null && !string.IsNullOrEmpty(membershipEvent.Action)) { MembershipReceived?.Invoke(this, new SseMembershipEventArgs(membershipEvent)); }\n        }\n        catch (JsonException) { }\n    }\n\n    private static bool IsCancellationException(Exception ex)\n    {\n        if (ex is OperationCanceledException or TaskCanceledException) return true;\n        var message = ex.Message.ToLowerInvariant();\n        return message.Contains(\"\"canceled\"\") || message.Contains(\"\"cancelled\"\") || message.Contains(\"\"socket closed\"\") || message.Contains(\"\"connection closed\"\") || message.Contains(\"\"request was canceled\"\") || message.Contains(\"\"the request was aborted\"\") || (ex is IOException && message.Contains(\"\"closed\"\"));\n    }\n\n    public void Dispose()\n    {\n        if (_disposed) return;\n        Stop();\n        lock (_connectionLock) { _cancellationTokenSource?.Dispose(); _cancellationTokenSource = null; }\n        _disposed = true;\n        GC.SuppressFinalize(this);\n    }\n}\nENDCONTENT\n)\necho \"\"$content\"\" >> \"\"C:\\Users\\stef\\source\\repos\\WayfarerMobile\\tests\\WayfarerMobile.Tests\\Unit\\Services\\SseClientTests.cs\"\")",
      "Bash(dotnet add package:*)",
      "Bash(powershell -ExecutionPolicy Bypass -File /tmp/update.ps1)",
      "Bash(copy:*)",
      "WebFetch(domain:mapsui.com)",
      "Bash(Sort-Object LastWriteTime -Descending)",
      "Bash(Select-Object -First 3)",
      "Bash(Get-Content $_FullName -Tail 100 })",
      "Bash(git commit -m \"$(cat <<''EOF''\nfeat: add robust periodic settings sync to foreground service\n\n- Add SettingsSyncService for app-side settings management\n- Implement bulletproof settings sync in LocationTrackingService\n- Timer checks hourly, syncs if 6+ hours elapsed\n- Comprehensive error handling - sync failures never affect GPS\n- Timeout protection (15s max for network operations)\n- Update thresholds and preferences on successful sync\n- Activity types sync on app startup (fire-and-forget)\nEOF\n)\")",
      "Bash(git commit -m \"$(cat <<''EOF''\nrefactor: simplify notification to Check In action only\n\n- Remove Pause/Resume/Stop actions from notification\n- Keep only Check In quick action for user convenience\n- Protects 24/7 location service design\n- Notification tap opens app, Check In triggers check-in flow\nEOF\n)\")",
      "Bash(git reset:*)"
    ]
  }
}
